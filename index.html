<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmar Presença</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #eef2f6; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .card-rsvp { max-width: 500px; width: 100%; border: none; shadow: 0 10px 25px rgba(0,0,0,0.1); border-radius: 15px; overflow: hidden; }
        .header-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; padding: 30px 20px; text-align: center; }
        .loading { display: none; text-align: center; padding: 20px; }
    </style>
</head>
<body>

<div class="card-rsvp">
    <div class="header-bg">
        <h2 id="nome-evento-titulo" class="fw-bold mb-0">Carregando...</h2>
        <p class="opacity-75 mb-0 mt-2">Confirmação de Presença</p>
    </div>

    <div class="card-body p-4 bg-white">
        
        <div id="loading" class="loading">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Aguarde...</p>
        </div>

        <div id="passo-1">
            <p class="text-center text-muted mb-4">Digite seu nome para confirmar sua presença na lista.</p>
            <form onsubmit="verificarNome(event)">
                <div class="mb-3">
                    <input type="text" id="input-nome-busca" class="form-control form-control-lg text-center" placeholder="Ex: Gabriel Felizardo" required>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg rounded-pill">Verificar</button>
                </div>
            </form>
        </div>

        <div id="passo-2" style="display:none;">
            <div class="alert alert-success border-0 text-center mb-4">Olá, <strong id="nome-encontrado"></strong>!</div>
            
            <form onsubmit="enviarResposta(event)">
                <input type="hidden" id="linha-convidado">
                
                <div class="mb-4 text-center">
                    <label class="form-label fw-bold d-block mb-3">Você poderá comparecer?</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="resp-Status" id="sim" value="Confirmado" checked>
                        <label class="btn btn-outline-success py-2" for="sim">Sim, eu vou!</label>

                        <input type="radio" class="btn-check" name="resp-Status" id="nao" value="Não vai">
                        <label class="btn btn-outline-danger py-2" for="nao">Não poderei ir</label>
                    </div>
                </div>

                <div id="perguntas-extras"></div>

                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-primary btn-lg rounded-pill">Enviar Confirmação</button>
                </div>
            </form>
        </div>

        <div id="passo-3" style="display:none;" class="text-center py-4">
            <i class="fas fa-check-circle text-success fa-5x mb-3"></i>
            <h3 class="fw-bold">Obrigado!</h3>
            <p class="text-muted">Sua resposta foi registrada.</p>
        </div>
    </div>
</div>

<script>
    // ============================================================
    // CONFIGURAÇÃO
    // ============================================================
    
    // COLE AQUI A MESMA URL QUE COLOCOU NO PAINEL
    const API_URL = "COLE_AQUI_A_SUA_URL_DO_GOOGLE_SCRIPT_QUE_TERMINA_EM_EXEC"; 

    // ============================================================

    const urlParams = new URLSearchParams(window.location.search);
    const eventoNome = urlParams.get('evento');

    if (eventoNome) {
        document.getElementById('nome-evento-titulo').innerText = eventoNome;
    } else {
        document.getElementById('nome-evento-titulo').innerText = "Evento";
        alert("Link inválido: Nome do evento não encontrado.");
    }

    async function chamarAPI(acao, dados = {}) {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('passo-1').style.display = 'none';
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ acao: acao, ...dados })
            });
            const json = await response.json();
            document.getElementById('loading').style.display = 'none';
            return json;
        } catch (e) {
            alert("Erro de conexão.");
            document.getElementById('loading').style.display = 'none';
            document.getElementById('passo-1').style.display = 'block';
            return null;
        }
    }

    async function verificarNome(e) {
        e.preventDefault();
        const nomeBusca = document.getElementById('input-nome-busca').value;
        const res = await chamarAPI('buscarConvidado', { nomeEvento: eventoNome, nomeBusca: nomeBusca });
        
        if (res && res.encontrado) {
            document.getElementById('nome-encontrado').innerText = res.nomeCompleto;
            document.getElementById('linha-convidado').value = res.linha;
            gerarFormulario(res.colunas, res.dadosAtuais);
            document.getElementById('passo-2').style.display = 'block';
        } else {
            alert("Nome não encontrado nesta lista.");
            document.getElementById('passo-1').style.display = 'block';
        }
    }

    function gerarFormulario(colunas, dadosAtuais) {
        const container = document.getElementById('perguntas-extras');
        container.innerHTML = "";
        colunas.forEach((col, index) => {
            if (col === "Nome" || col === "Status" || col === "Telefone" || col === "Email") return;
            const valor = dadosAtuais[index];
            container.innerHTML += `
                <div class="mb-3">
                    <label class="form-label fw-bold">${col}</label>
                    <input type="text" class="form-control" name="extra-${col}" value="${valor}" placeholder="Sua resposta...">
                </div>`;
        });
    }

    async function enviarResposta(e) {
        e.preventDefault();
        const linha = document.getElementById('linha-convidado').value;
        const status = document.querySelector('input[name="resp-Status"]:checked').value;
        let respostas = { "Status": status };
        
        document.querySelectorAll('input[name^="extra-"]').forEach(input => {
            respostas[input.name.replace("extra-", "")] = input.value;
        });

        const res = await chamarAPI('salvarResposta', { nomeEvento: eventoNome, linha: linha, respostas: respostas });
        if (res && res.sucesso) {
            document.getElementById('passo-2').style.display = 'none';
            document.getElementById('passo-3').style.display = 'block';
        }
    }
</script>
</body>
</html>
