<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel RSVP v17.0</title>
  <?!= HtmlService.createHtmlOutputFromFile('styles').getContent(); ?>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

  <header class="header">
    <div class="header-left">
      <h1>Sistema RSVP</h1>
      <span class="versao">v17.0</span>
    </div>
    <div class="header-right">
      <span id="emailUsuario"></span>
    </div>
  </header>

  <div id="modoPlanejamento" class="modo-ativo">
    <section class="section">
      <div class="section-header">
        <h2>Meus Eventos</h2>
        <button class="btn-primary" onclick="abrirModalNovoEvento()">+ Novo Evento</button>
      </div>
      <div id="listaEventos" class="eventos-grid"></div>
    </section>
  </div>

  <div id="modoCheckin" class="modo-inativo">
    <div class="stats-banner">
      <div class="stat-item stat-total">
        <div class="stat-value" id="statTotal">0</div>
        <div class="stat-label">Total</div>
      </div>
      <div class="stat-item stat-confirmados">
        <div class="stat-value" id="statConfirmados">0</div>
        <div class="stat-label">Presentes</div>
      </div>
      <div class="stat-item stat-pendentes">
        <div class="stat-value" id="statPendentes">0</div>
        <div class="stat-label">Faltam</div>
      </div>
    </div>

    <div class="search-container" style="max-width: 600px; margin: 20px auto; padding: 0 16px;">
      <input type="text" id="inputBusca" placeholder="Buscar convidado..." onkeyup="filtrarCheckin()">
    </div>

    <div id="listaCheckin" class="checkin-grid"></div>

    <button class="btn-secondary" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);" onclick="alternarModo(false)">
      ‚Üê Voltar ao Planejamento
    </button>
  </div>

  <div id="modalNovoEvento" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3>Novo Evento</h3><button class="modal-close" onclick="fecharModal('modalNovoEvento')">√ó</button></div>
      <div class="modal-body">
        <div class="form-group" style="margin-bottom: 15px;">
          <label>Nome do Evento</label>
          <input type="text" id="inputNomeEvento">
        </div>
        <div class="form-group">
          <label>Colunas Personalizadas (Al√©m de Nome e Presen√ßa)</label>
          <div id="colunasContainer"></div>
          <button class="btn-secondary btn-small" onclick="addColField()">+ Coluna</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="fecharModal('modalNovoEvento')">Cancelar</button>
        <button class="btn-primary" onclick="salvarNovoEvento()">Criar Evento</button>
      </div>
    </div>
  </div>

  <div id="modalEvento" class="modal">
    <div class="modal-content modal-large" style="max-width: 900px;">
      <div class="modal-header">
        <h3 id="tituloEvento"></h3>
        <button class="modal-close" onclick="fecharModal('modalEvento')">√ó</button>
      </div>
      <div class="modal-body">
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
          <button class="btn-primary" onclick="alternarModo(true)">üì± Modo Check-in</button>
          <button class="btn-secondary" onclick="abrirModalConvidado()">+ Convidado</button>
          <button class="btn-secondary" onclick="document.getElementById('inputExcel').click()">Importar Excel</button>
          <input type="file" id="inputExcel" accept=".xlsx" style="display:none" onchange="lerExcel(this)">
          <button class="btn-danger" onclick="excluirEventoAtual()">Excluir Evento</button>
        </div>
        <div id="tabelaConvidados" class="table-container"></div>
      </div>
    </div>
  </div>

  <div id="modalConvidado" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3>Adicionar Convidado</h3><button class="modal-close" onclick="fecharModal('modalConvidado')">√ó</button></div>
      <div class="modal-body" id="formConvidado"></div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="fecharModal('modalConvidado')">Cancelar</button>
        <button class="btn-primary" onclick="salvarConvidado()">Salvar</button>
      </div>
    </div>
  </div>

  <div id="loadingOverlay" class="loading-overlay"><p>Carregando...</p></div>
  <div id="toast" class="toast"></div>

  <script>
    let ESTADO = { eventos: [], eventoAtual: null, convidados: [], colunas: [] };

    window.onload = inicializar;

    function inicializar() {
      mostrarLoading(true);
      google.script.run.withSuccessHandler(sessao => {
        if (!sessao.autenticado) {
          alert('Fa√ßa login no Google para continuar.');
          return;
        }
        document.getElementById('emailUsuario').textContent = sessao.email;
        carregarEventos();
      }).obterSessao();
    }

    function carregarEventos() {
      google.script.run.withSuccessHandler(res => {
        if (res.sucesso) {
          ESTADO.eventos = res.eventos;
          renderizarEventos();
        }
        mostrarLoading(false);
      }).listarEventos();
    }

    function renderizarEventos() {
      const container = document.getElementById('listaEventos');
      container.innerHTML = ESTADO.eventos.map(ev => `
        <div class="evento-card" onclick="abrirEvento('${ev.nome}')">
          <h3>${ev.nome}</h3>
          <div class="info-item"><span class="label">Total:</span><span class="value">${ev.totalConvidados}</span></div>
          <div class="info-item"><span class="label">Confirmados:</span><span class="value">${ev.confirmados}</span></div>
        </div>
      `).join('');
    }

    function abrirEvento(nome) {
      mostrarLoading(true);
      ESTADO.eventoAtual = nome;
      google.script.run.withSuccessHandler(res => {
        if (res.sucesso) {
          ESTADO.convidados = res.convidados;
          ESTADO.colunas = res.colunas;
          document.getElementById('tituloEvento').textContent = nome;
          renderizarTabela();
          document.getElementById('modalEvento').classList.add('ativo');
        }
        mostrarLoading(false);
      }).obterConvidados(nome);
    }

    function renderizarTabela() {
      const tb = document.getElementById('tabelaConvidados');
      let html = '<table class="table"><thead><tr>';
      ESTADO.colunas.forEach(c => html += `<th>${c}</th>`);
      html += '<th>A√ß√£o</th></tr></thead><tbody>';
      
      ESTADO.convidados.forEach(c => {
        html += '<tr>';
        ESTADO.colunas.forEach(col => html += `<td>${c[col]}</td>`);
        html += `<td><button onclick="excluirConvidado(${c._linha})">üóëÔ∏è</button></td></tr>`;
      });
      tb.innerHTML = html + '</tbody></table>';
    }

    // CHECK-IN MODE
    function alternarModo(ativo) {
      document.getElementById('modoPlanejamento').className = ativo ? 'modo-inativo' : 'modo-ativo';
      document.getElementById('modoCheckin').className = ativo ? 'modo-ativo' : 'modo-inativo';
      if (ativo) {
        fecharModal('modalEvento');
        renderizarCheckin();
        atualizarStats();
      }
    }

    function renderizarCheckin() {
      const container = document.getElementById('listaCheckin');
      const termo = document.getElementById('inputBusca').value.toLowerCase();
      
      container.innerHTML = ESTADO.convidados.map(c => {
        if (!c['Nome'].toLowerCase().includes(termo)) return '';
        const confirmado = c['Presen√ßa'] === 'Confirmado';
        return `
          <div class="checkin-card ${confirmado ? 'confirmado' : ''}" onclick="togglePresenca(${c._linha})">
            <div>
              <div class="checkin-nome">${c['Nome']}</div>
              <div style="color:var(--cinza-medio)">${c[ESTADO.colunas[1]] || ''}</div>
            </div>
            <div class="badge-checkin" style="background:${confirmado?'var(--verde)':'var(--cinza-claro)'; color:${confirmado?'white':'var(--cinza-medio)'}">
              ${confirmado ? '‚úì PRESENTE' : 'PENDENTE'}
            </div>
          </div>
        `;
      }).join('');
    }

    function togglePresenca(linha) {
      google.script.run.withSuccessHandler(res => {
        if (res.sucesso) {
          const conv = ESTADO.convidados.find(c => c._linha === linha);
          conv['Presen√ßa'] = res.novoStatus;
          renderizarCheckin();
          atualizarStats();
        }
      }).togglePresenca(ESTADO.eventoAtual, linha);
    }

    function atualizarStats() {
      const total = ESTADO.convidados.length;
      const conf = ESTADO.convidados.filter(c => c['Presen√ßa'] === 'Confirmado').length;
      document.getElementById('statTotal').innerText = total;
      document.getElementById('statConfirmados').innerText = conf;
      document.getElementById('statPendentes').innerText = total - conf;
    }

    // UTILS
    function mostrarLoading(b) { document.getElementById('loadingOverlay').classList.toggle('ativo', b); }
    function fecharModal(id) { document.getElementById(id).classList.remove('ativo'); }
    
    // CRIAR EVENTO
    function abrirModalNovoEvento() { 
      document.getElementById('modalNovoEvento').classList.add('ativo'); 
      document.getElementById('colunasContainer').innerHTML = '';
    }
    function addColField() {
      const div = document.createElement('div');
      div.innerHTML = `<input type="text" class="col-input" placeholder="Nome Coluna" style="margin-bottom:5px">`;
      document.getElementById('colunasContainer').appendChild(div);
    }
    function salvarNovoEvento() {
      const nome = document.getElementById('inputNomeEvento').value;
      const cols = Array.from(document.querySelectorAll('.col-input')).map(i => i.value).filter(v => v);
      mostrarLoading(true);
      google.script.run.withSuccessHandler(res => {
        if(res.sucesso) { fecharModal('modalNovoEvento'); carregarEventos(); }
        else alert(res.mensagem);
        mostrarLoading(false);
      }).criarEvento(nome, cols);
    }

    // CONVIDADOS
    function abrirModalConvidado() {
      const div = document.getElementById('formConvidado');
      let html = '';
      ESTADO.colunas.forEach(c => {
        if (c !== 'Presen√ßa') html += `<label>${c}</label><input class="inp-conv" data-col="${c}" style="width:100%;margin-bottom:10px">`;
      });
      div.innerHTML = html;
      document.getElementById('modalConvidado').classList.add('ativo');
    }
    function salvarConvidado() {
      const inputs = document.querySelectorAll('.inp-conv');
      const dados = {};
      inputs.forEach(i => dados[i.dataset.col] = i.value);
      mostrarLoading(true);
      google.script.run.withSuccessHandler(res => {
        if(res.sucesso) {
          fecharModal('modalConvidado');
          abrirEvento(ESTADO.eventoAtual); // Recarrega
        }
        mostrarLoading(false);
      }).adicionarConvidado(ESTADO.eventoAtual, dados);
    }
    function excluirConvidado(linha) {
      if(confirm('Excluir?')) {
        google.script.run.withSuccessHandler(() => abrirEvento(ESTADO.eventoAtual)).excluirConvidado(ESTADO.eventoAtual, linha);
      }
    }
    function excluirEventoAtual() {
      if(confirm('Excluir evento inteiro?')) {
        google.script.run.withSuccessHandler(() => {
          fecharModal('modalEvento');
          carregarEventos();
        }).excluirEvento(ESTADO.eventoAtual);
      }
    }

    // IMPORTA√á√ÉO EXCEL
    function lerExcel(input) {
      const file = input.files[0];
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        mostrarLoading(true);
        google.script.run.withSuccessHandler(() => {
          abrirEvento(ESTADO.eventoAtual);
          mostrarLoading(false);
        }).importarConvidadosExcel(ESTADO.eventoAtual, json);
      };
      reader.readAsArrayBuffer(file);
    }
    
    function filtrarCheckin() { renderizarCheckin(); }
  </script>
</body>
</html>
