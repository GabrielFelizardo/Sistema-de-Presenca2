<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor RSVP - GitHub</title>
  
  <style>
    /* CSS SWISS DESIGN (Mesmo de antes) */
    :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; --white: #ffffff; --green: #10b981; --red: #ef4444; }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
    .hide { display: none !important; }
    
    /* LOGIN */
    #tela-login { position: fixed; inset: 0; background: linear-gradient(135deg, #1e3a8a, #3b82f6); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .login-box { background: white; padding: 40px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    .input-group { margin-bottom: 16px; text-align: left; }
    .input-group input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 1rem; }
    .btn { padding: 12px; width: 100%; border: none; border-radius: 8px; background: var(--primary); color: white; cursor: pointer; font-size: 1rem; }
    .btn:hover { opacity: 0.9; }

    /* APP */
    #app-principal { display: flex; height: 100vh; }
    .sidebar { width: 260px; background: white; border-right: 1px solid #e2e8f0; padding: 24px; display: flex; flex-direction: column; }
    .logo { font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-bottom: 32px; }
    .user-info { margin-top: auto; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 0.9rem; color: #64748b; }
    .main-content { flex: 1; overflow-y: auto; padding: 32px; }
    
    /* CARDS */
    .grid-eventos { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
    .card-evento { background: white; padding: 24px; border-radius: 12px; border: 1px solid #e2e8f0; cursor: pointer; transition: 0.2s; }
    .card-evento:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
    
    /* MODAIS */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; }
    .modal-box { background: white; width: 90%; max-width: 500px; padding: 24px; border-radius: 12px; max-height: 90vh; overflow-y: auto; }
    .modal-large { max-width: 900px; }
    
    /* CHECKIN FULLSCREEN */
    #view-checkin { position: fixed; inset: 0; background: var(--bg); z-index: 1500; display: flex; flex-direction: column; }
    .checkin-header { background: white; padding: 16px; border-bottom: 1px solid #e2e8f0; display: flex; gap: 16px; align-items: center; }
    .checkin-grid { flex: 1; overflow-y: auto; padding: 16px; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; align-content: start; }
    .guest-card { background: white; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .guest-card.presente { border-color: var(--green); background: #f0fdf4; }
    
    /* LOADER */
    #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 3000; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: 600; }
    
    /* TABLE */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background: #f8fafc; color: #64748b; font-size: 0.85rem; text-transform: uppercase; }
  </style>
</head>
<body>

  <div id="loader" class="hide">Carregando...</div>

  <div id="tela-login">
    <div class="login-box">
      <h2>Gestor RSVP</h2>
      <p>Digite seu e-mail para entrar.</p>
      <form onsubmit="handleLogin(event)">
        <div class="input-group">
          <input type="email" id="emailInput" placeholder="seu@email.com" required>
        </div>
        <button type="submit" class="btn">Entrar / Criar Conta</button>
      </form>
    </div>
  </div>

  <div id="app-principal" class="hide">
    <div class="sidebar">
      <div class="logo">üìÖ Gestor RSVP</div>
      <div style="flex:1"></div>
      <div class="user-info">
        <div id="userEmailDisplay" style="margin-bottom:10px; font-weight:500"></div>
        <button onclick="handleLogout()" style="background:none; border:none; color:var(--red); cursor:pointer">Sair</button>
      </div>
    </div>

    <div class="main-content">
      <div id="view-dashboard">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <h2>Meus Eventos</h2>
          <button onclick="abrirModalNovo()" class="btn" style="width:auto">+ Novo Evento</button>
        </div>
        <div id="lista-eventos" class="grid-eventos"></div>
      </div>
    </div>
  </div>

  <div id="modal-novo" class="modal-overlay hide">
    <div class="modal-box">
      <h3>Novo Evento</h3>
      <div class="input-group" style="margin-top:20px">
        <input type="text" id="novoNomeEvento" placeholder="Nome do Evento">
      </div>
      <div class="input-group">
        <input type="text" id="novoColunas" placeholder="Colunas extras (separadas por v√≠rgula)">
        <small style="color:#64748b">Ex: Empresa, Cargo, Mesa</small>
      </div>
      <div style="display:flex; gap:10px">
        <button onclick="fecharModais()" style="background:#e2e8f0; color:#1e293b" class="btn">Cancelar</button>
        <button onclick="criarEvento()" class="btn">Criar</button>
      </div>
    </div>
  </div>

  <div id="modal-evento" class="modal-overlay hide">
    <div class="modal-box modal-large">
      <div style="display:flex; justify-content:space-between">
        <h3 id="tituloEventoDetalhe">Evento</h3>
        <button onclick="fecharModais()" style="background:none; border:none; font-size:1.5rem; cursor:pointer">√ó</button>
      </div>
      <div style="margin-top:20px; display:flex; gap:10px; flex-wrap:wrap">
        <button onclick="iniciarCheckin()" class="btn" style="width:auto">üì± Check-in</button>
        <button onclick="abrirModalAddConvidado()" class="btn" style="width:auto; background:#fff; border:1px solid #ddd; color:#333">+ Convidado</button>
        <button onclick="excluirEventoAtual()" class="btn" style="width:auto; background:var(--red); margin-left:auto">Excluir</button>
      </div>
      <div id="tabela-container" style="overflow-x:auto"></div>
    </div>
  </div>

  <div id="modal-add-convidado" class="modal-overlay hide">
    <div class="modal-box">
      <h3>Novo Convidado</h3>
      <div id="form-convidado-dinamico" style="margin:20px 0"></div>
      <button onclick="salvarConvidado()" class="btn">Salvar</button>
      <button onclick="document.getElementById('modal-add-convidado').classList.add('hide')" class="btn" style="margin-top:10px; background:#fff; color:#333; border:1px solid #ddd">Cancelar</button>
    </div>
  </div>

  <div id="view-checkin" class="checkin-view hide">
    <div class="checkin-header">
      <button onclick="sairCheckin()" style="background:none; border:none; font-size:1.5rem; cursor:pointer">‚Üê</button>
      <input type="text" id="buscaCheckin" placeholder="Buscar nome..." style="flex:1; padding:12px; border:1px solid #e2e8f0; border-radius:8px" onkeyup="renderizarCheckin()">
      <div id="statCheckin" style="font-weight:bold; color:var(--primary)">0 / 0</div>
    </div>
    <div id="grid-checkin" class="checkin-grid"></div>
  </div>

  <script>
    
    const API_URL = "https://script.google.com/macros/s/AKfycbwGutHWpTh58I3ir4oVh_af3WqzDObYKIOSfH3MPfN2Go15FMu4vsApmg6GWxN_FhBW/exec"; 
  
    let ESTADO = { eventos: [], eventoAtual: null, convidados: [], colunas: [], idPlanilha: null, email: null };

    // INICIALIZA√á√ÉO
    window.onload = function() {
      const idSalvo = localStorage.getItem('rsvp_id');
      const emailSalvo = localStorage.getItem('rsvp_email');
      
      if(idSalvo && emailSalvo) {
        ESTADO.idPlanilha = idSalvo;
        ESTADO.email = emailSalvo;
        mostrarApp();
      }
    };

    // --- FUN√á√ÉO DE COMUNICA√á√ÉO (FETCH) ---
    async function chamarAPI(acao, dados = {}) {
      if(ESTADO.idPlanilha) dados.idPlanilha = ESTADO.idPlanilha;
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ acao: acao, ...dados })
        });
        const json = await response.json();
        if(json.erro || json.sucesso === false) {
          alert("Erro: " + (json.mensagem || json.erro));
          return null;
        }
        return json;
      } catch(e) {
        alert("Erro de conex√£o. Verifique a URL do Script.");
        console.error(e);
        return null;
      }
    }

    // LOGIN
    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('emailInput').value;
      mostrarLoader(true);
      
      const res = await chamarAPI('fazerLogin', { email: email });
      mostrarLoader(false);
      
      if(res && res.sucesso) {
        ESTADO.idPlanilha = res.idPlanilha;
        ESTADO.email = res.email;
        localStorage.setItem('rsvp_id', res.idPlanilha);
        localStorage.setItem('rsvp_email', res.email);
        mostrarApp();
      }
    }

    function handleLogout() {
      localStorage.clear();
      location.reload();
    }

    function mostrarApp() {
      document.getElementById('tela-login').classList.add('hide');
      document.getElementById('app-principal').classList.remove('hide');
      document.getElementById('userEmailDisplay').textContent = ESTADO.email;
      carregarEventos();
    }

    // EVENTOS
    async function carregarEventos() {
      mostrarLoader(true);
      const res = await chamarAPI('listarEventos');
      mostrarLoader(false);
      if(res) {
        ESTADO.eventos = res.eventos;
        renderizarEventos();
      }
    }

    function renderizarEventos() {
      const div = document.getElementById('lista-eventos');
      div.innerHTML = ESTADO.eventos.map(ev => `
        <div class="card-evento" onclick="abrirEvento('${ev.nome}')">
          <h3>${ev.nome}</h3>
          <div style="display:flex; justify-content:space-between; font-size:0.9rem; color:#64748b">
            <span>Total: <b>${ev.total}</b></span>
            <span style="color:var(--green)">Confirmados: <b>${ev.confirmados}</b></span>
          </div>
        </div>
      `).join('');
    }

    async function criarEvento() {
      const nome = document.getElementById('novoNomeEvento').value;
      const cols = document.getElementById('novoColunas').value.split(',').map(c=>c.trim()).filter(c=>c);
      mostrarLoader(true);
      const res = await chamarAPI('criarEvento', { nome: nome, colunas: cols });
      mostrarLoader(false);
      if(res) {
        fecharModais();
        carregarEventos();
      }
    }

    // DETALHES & CONVIDADOS
    async function abrirEvento(nome) {
      ESTADO.eventoAtual = nome;
      document.getElementById('tituloEventoDetalhe').innerText = nome;
      mostrarLoader(true);
      const res = await chamarAPI('obterConvidados', { nomeEvento: nome });
      mostrarLoader(false);
      
      if(res) {
        ESTADO.convidados = res.convidados;
        ESTADO.colunas = res.colunas;
        renderizarTabela();
        document.getElementById('modal-evento').classList.remove('hide');
      }
    }

    function renderizarTabela() {
      const div = document.getElementById('tabela-container');
      if(ESTADO.convidados.length === 0) {
        div.innerHTML = '<p style="text-align:center; padding:20px; color:#64748b;">Nenhum convidado.</p>';
        return;
      }
      let html = '<table><thead><tr>';
      ESTADO.colunas.forEach(c => html += `<th>${c}</th>`);
      html += '<th></th></tr></thead><tbody>';
      ESTADO.convidados.forEach(conv => {
        html += '<tr>';
        ESTADO.colunas.forEach(col => {
          let val = conv[col];
          if(col === 'Presen√ßa' && val === 'Confirmado') val = '‚úÖ';
          html += `<td>${val || '-'}</td>`;
        });
        html += `<td><button onclick="excluirConvidado(${conv._linha})" style="color:var(--red); border:none; background:none; cursor:pointer">üóëÔ∏è</button></td></tr>`;
      });
      div.innerHTML = html + '</tbody></table>';
    }

    async function salvarConvidado() {
      const inputs = document.querySelectorAll('.input-convidado');
      let dados = {};
      inputs.forEach(i => dados[i.dataset.col] = i.value);
      mostrarLoader(true);
      const res = await chamarAPI('adicionarConvidado', { nomeEvento: ESTADO.eventoAtual, dados: dados });
      mostrarLoader(false);
      if(res) {
        document.getElementById('modal-add-convidado').classList.add('hide');
        abrirEvento(ESTADO.eventoAtual);
      }
    }

    async function excluirConvidado(linha) {
      if(!confirm("Excluir?")) return;
      mostrarLoader(true);
      await chamarAPI('excluirConvidado', { nomeEvento: ESTADO.eventoAtual, linha: linha });
      abrirEvento(ESTADO.eventoAtual); // Recarrega
    }
    
    async function excluirEventoAtual() {
      if(!confirm("Apagar evento inteiro?")) return;
      mostrarLoader(true);
      await chamarAPI('excluirEvento', { nomeEvento: ESTADO.eventoAtual });
      fecharModais();
      carregarEventos();
    }

    // CHECK-IN
    function iniciarCheckin() {
      document.getElementById('view-checkin').classList.remove('hide');
      renderizarCheckin();
    }
    function sairCheckin() {
      document.getElementById('view-checkin').classList.add('hide');
      abrirEvento(ESTADO.eventoAtual); // Atualiza tabela
    }
    function renderizarCheckin() {
      const grid = document.getElementById('grid-checkin');
      const termo = document.getElementById('buscaCheckin').value.toLowerCase();
      let confirmados = 0;
      
      grid.innerHTML = ESTADO.convidados.map(c => {
        const isConf = c['Presen√ßa'] === 'Confirmado';
        if(isConf) confirmados++;
        if(!c['Nome'].toLowerCase().includes(termo)) return '';
        
        return `
          <div class="guest-card ${isConf ? 'presente' : ''}" onclick="togglePresenca(${c._linha})">
            <div>
              <div style="font-weight:600; font-size:1.1rem">${c['Nome']}</div>
              <div style="color:#64748b; font-size:0.9rem">${c[ESTADO.colunas[1]] || ''}</div>
            </div>
            <div class="check-btn">‚úì</div>
          </div>`;
      }).join('');
      document.getElementById('statCheckin').innerText = `${confirmados} / ${ESTADO.convidados.length}`;
    }

    async function togglePresenca(linha) {
      // Otimista (Muda na tela antes do servidor)
      const conv = ESTADO.convidados.find(c => c._linha === linha);
      conv['Presen√ßa'] = conv['Presen√ßa'] === 'Confirmado' ? '' : 'Confirmado';
      renderizarCheckin();
      
      // Envia ao servidor
      await chamarAPI('togglePresenca', { nomeEvento: ESTADO.eventoAtual, linha: linha });
    }

    // UTILS
    function mostrarLoader(b) { document.getElementById('loader').classList.toggle('hide', !b); }
    function fecharModais() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hide')); }
    function abrirModalNovo() { document.getElementById('modal-novo').classList.remove('hide'); }
    function abrirModalAddConvidado() {
      const div = document.getElementById('form-convidado-dinamico');
      div.innerHTML = '';
      ESTADO.colunas.forEach(c => {
        if(c!=='Presen√ßa') div.innerHTML += `<div style="margin-bottom:10px"><label style="display:block;font-size:0.8rem;color:#64748b">${c}</label><input class="input-convidado" data-col="${c}" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px"></div>`;
      });
      document.getElementById('modal-add-convidado').classList.remove('hide');
    }
  </script>
</body>
</html>

