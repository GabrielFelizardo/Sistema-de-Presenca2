<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check-in Pro</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    /* BASEADO NO SEU ARQUIVO + MELHORIAS DE UX */
    :root { --primary: #2563eb; --primary-dark: #1e3a8a; --bg: #f1f5f9; --text: #0f172a; --white: #ffffff; --green: #10b981; --red: #ef4444; }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    body { background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }
    .hide { display: none !important; }
    
    /* LOGIN */
    #tela-login { position: fixed; inset: 0; background: linear-gradient(135deg, #1e3a8a, #3b82f6); z-index: 5000; display: flex; align-items: center; justify-content: center; }
    .login-box { background: white; padding: 40px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    .input-login { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; }
    
    /* LAYOUT PADR√ÉO (PLANEJAMENTO) */
    .sidebar { width: 260px; background: var(--white); border-right: 1px solid #e2e8f0; padding: 24px; display: flex; flex-direction: column; transition: 0.3s; }
    .logo { font-size: 1.4rem; font-weight: 800; color: var(--primary); margin-bottom: 32px; display: flex; align-items: center; gap: 10px; }
    .nav-btn { width: 100%; text-align: left; padding: 12px; margin-bottom: 4px; background: none; border: none; border-radius: 8px; color: #64748b; font-weight: 600; cursor: pointer; }
    .nav-btn:hover, .nav-btn.active { background: #eff6ff; color: var(--primary); }
    .main { flex: 1; padding: 32px; overflow-y: auto; position: relative; }
    
    /* CARDS EVENTOS */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .card { background: var(--white); padding: 24px; border-radius: 12px; border: 1px solid #e2e8f0; cursor: pointer; transition: 0.2s; }
    .card:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
    .stat-row { display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9rem; color: #64748b; }
    .stat-val { font-weight: 700; color: var(--text); }
    
    /* MODAIS */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .modal { background: var(--white); padding: 24px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
    .modal-lg { max-width: 900px; }
    .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: white; border: 1px solid #cbd5e1; color: var(--text); }
    .btn-danger { background: #fee2e2; color: var(--red); }
    
    /* TABLE */
    .table-container { overflow-x: auto; margin-top: 20px; border: 1px solid #e2e8f0; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; background: white; }
    th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; }
    th { background: #f8fafc; color: #64748b; text-transform: uppercase; font-size: 0.8rem; }
    
    /* ================================================= */
    /* üöÄ MODO CHECK-IN (TRANSFORMA√á√ÉO VISUAL) */
    /* ================================================= */
    
    body.checkin-active .sidebar { display: none; }
    body.checkin-active .main { padding: 0; background: var(--bg); }
    
    /* BARRA FIXA DE ESTAT√çSTICAS */
    .checkin-stats { 
        position: sticky; top: 0; z-index: 100; background: white; 
        padding: 15px 20px; border-bottom: 1px solid #e2e8f0; 
        display: none; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    body.checkin-active .checkin-stats { display: flex; }
    
    .stat-pill { background: #f1f5f9; padding: 8px 16px; border-radius: 50px; font-weight: 700; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
    .stat-presente { background: #dcfce7; color: #166534; }
    
    /* BUSCA GIGANTE */
    .big-search { width: 100%; padding: 15px; font-size: 1.2rem; border: 2px solid #cbd5e1; border-radius: 12px; margin: 20px 0; display: none; }
    body.checkin-active .big-search { display: block; }
    
    /* GRID DE CART√ïES (CHECK-IN) */
    .guest-grid { display: none; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; padding-bottom: 80px; }
    body.checkin-active .guest-grid { display: grid; }
    
    .guest-card { background: white; padding: 20px; border-radius: 12px; border: 2px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
    .guest-card.checked { background: #f0fdf4; border-color: var(--green); }
    .guest-name { font-size: 1.1rem; font-weight: 700; color: var(--text); }
    .guest-info { font-size: 0.9rem; color: #64748b; margin-top: 4px; }
    
    .check-btn { width: 50px; height: 50px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; transition: 0.2s; }
    .guest-card.checked .check-btn { background: var(--green); transform: scale(1.1); }
    
    /* BOT√ÉO SAIR MODO CHECK-IN */
    .btn-exit-checkin { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--text); color: white; padding: 12px 30px; border-radius: 50px; font-weight: 600; box-shadow: 0 10px 20px rgba(0,0,0,0.2); display: none; border: none; cursor: pointer; z-index: 200; }
    body.checkin-active .btn-exit-checkin { display: block; }
    
    /* UTILS */
    .loader { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; font-weight: 600; color: var(--primary); }
    .toast { position: fixed; bottom: 20px; right: 20px; background: #1e293b; color: white; padding: 12px 24px; border-radius: 8px; z-index: 9999; transform: translateY(100px); transition: 0.3s; }
    .toast.show { transform: translateY(0); }
  </style>
</head>
<body>

  <div id="loader" class="loader hide">Carregando...</div>
  <div id="toast" class="toast">Sucesso!</div>

  <div id="tela-login">
    <div class="login-box">
      <div style="font-size:3rem; margin-bottom:10px">üì±</div>
      <h2>Check-in Pro</h2>
      <p style="color:#64748b; margin-bottom:20px">Gest√£o de lista e controle de acesso.</p>
      <form onsubmit="handleLogin(event)">
        <input type="email" id="emailInput" class="input-login" placeholder="seu@email.com" required>
        <button type="submit" class="btn btn-primary" style="width:100%">Entrar / Criar</button>
      </form>
    </div>
  </div>

  <div id="app-principal" class="hide" style="display:flex; width:100%; height:100%">
    
    <div class="sidebar">
      <div class="logo">üìÖ Gestor RSVP</div>
      <button class="nav-btn active" onclick="nav('dashboard')">üìä Meus Eventos</button>
      <button class="nav-btn" onclick="nav('banco')">üë• Banco Nomes</button>
      <div style="margin-top:auto; padding-top:20px; border-top:1px solid #e2e8f0">
        <small id="userEmail" style="display:block; margin-bottom:10px; color:#64748b"></small>
        <button onclick="logout()" class="btn btn-secondary" style="width:100%">Sair</button>
      </div>
    </div>

    <div class="main">
      
      <div id="view-dashboard">
        <div class="header">
          <h2>Meus Eventos</h2>
          <button class="btn btn-primary" onclick="abrirModalNovo()">+ Novo Evento</button>
        </div>
        <div id="lista-eventos" class="grid"></div>
      </div>

      <div id="view-banco" class="hide">
        <div class="header"><h2>Banco de Nomes</h2></div>
        <div class="table-container">
          <table id="tabela-banco"><thead><tr><th>Nome</th><th>Info Extra</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div id="area-checkin" style="display:none">
        <div class="checkin-stats">
          <div class="stat-pill" style="color:var(--text)">Total: <span id="ck-total">0</span></div>
          <div class="stat-pill stat-presente">Presentes: <span id="ck-presentes">0</span></div>
        </div>
        <div style="padding:0 20px">
          <input type="text" class="big-search" id="buscaCheckin" placeholder="üîç Buscar nome..." onkeyup="renderCheckin()">
          <div id="grid-checkin" class="guest-grid"></div>
        </div>
        <button class="btn-exit-checkin" onclick="sairModoCheckin()">Sair do Modo Check-in</button>
      </div>

    </div>
  </div>

  <div id="modal-novo" class="overlay hide">
    <div class="modal">
      <div class="modal-header"><h3>Novo Evento</h3><button onclick="fecharModais()" style="background:none;border:none;font-size:1.5rem">√ó</button></div>
      <label>Nome do Evento</label>
      <input type="text" id="novoNome">
      <label>Colunas Extras (separadas por v√≠rgula)</label>
      <input type="text" id="novoColunas" placeholder="Empresa, Cargo, Mesa">
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="fecharModais()">Cancelar</button>
        <button class="btn btn-primary" onclick="criarEvento()">Criar</button>
      </div>
    </div>
  </div>

  <div id="modal-evento" class="overlay hide">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h3 id="tituloEvento">Evento</h3>
        <button onclick="fecharModais()" style="background:none;border:none;font-size:1.5rem">√ó</button>
      </div>
      
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px">
        <button class="btn btn-primary" onclick="entrarModoCheckin()">üöÄ INICIAR CHECK-IN</button>
        <button class="btn btn-secondary" onclick="modalConvidado()">+ Pessoa</button>
        <button class="btn btn-secondary" onclick="document.getElementById('inputImport').click()">Importar Excel</button>
        <input type="file" id="inputImport" hidden onchange="importarXLS(this)">
        <button class="btn btn-danger" style="margin-left:auto" onclick="excluirEvento()">Excluir</button>
      </div>

      <div id="tabela-container" class="table-container"></div>
    </div>
  </div>

  <div id="modal-pessoa" class="overlay hide">
    <div class="modal">
      <div class="modal-header"><h3>Adicionar Pessoa</h3><button onclick="document.getElementById('modal-pessoa').classList.add('hide')" style="background:none;border:none;font-size:1.5rem">√ó</button></div>
      <div id="form-pessoa"></div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="salvarPessoa()">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    // üëáüëá URL DO SEU SCRIPT AQUI üëáüëá
    const API_URL = "https://script.google.com/macros/s/AKfycbwGutHWpTh58I3ir4oVh_af3WqzDObYKIOSfH3MPfN2Go15FMu4vsApmg6GWxN_FhBW/exec"; 

    let ESTADO = { id: null, email: null, eventos: [], eventoAtual: null, dadosEvento: [], colunas: [], banco: [] };

    window.onload = () => {
      const savedId = localStorage.getItem('rsvp_id_v19');
      const savedEmail = localStorage.getItem('rsvp_email_v19');
      if(savedId) { ESTADO.id = savedId; ESTADO.email = savedEmail; iniciarApp(); }
    };

    async function api(acao, dados={}) {
      if(ESTADO.id) dados.idPlanilha = ESTADO.id;
      document.getElementById('loader').classList.remove('hide');
      try {
        const r = await fetch(API_URL, { method:'POST', body:JSON.stringify({acao, ...dados}) });
        const j = await r.json();
        document.getElementById('loader').classList.add('hide');
        return j;
      } catch(e) {
        document.getElementById('loader').classList.add('hide');
        alert("Erro de conex√£o"); return null;
      }
    }

    // LOGIN
    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('emailInput').value;
      const r = await api('fazerLogin', {email});
      if(r && r.sucesso) {
        ESTADO.id = r.idPlanilha; ESTADO.email = r.email;
        localStorage.setItem('rsvp_id_v19', r.idPlanilha);
        localStorage.setItem('rsvp_email_v19', r.email);
        iniciarApp();
      }
    }

    function iniciarApp() {
      document.getElementById('tela-login').classList.add('hide');
      document.getElementById('app-principal').classList.remove('hide');
      document.getElementById('userEmail').innerText = ESTADO.email;
      carregarEventos();
      carregarBanco();
    }

    function logout() { localStorage.clear(); location.reload(); }

    // EVENTOS
    async function carregarEventos() {
      const r = await api('listarEventos');
      if(r && r.sucesso) {
        ESTADO.eventos = r.eventos;
        const div = document.getElementById('lista-eventos');
        div.innerHTML = ESTADO.eventos.map(e => `
          <div class="card" onclick="abrirEvento('${e.nome}')">
            <h3>${e.nome}</h3>
            <div class="stat-row"><span>Total: <b>${e.total}</b></span><span style="color:var(--green)">Presentes: <b>${e.presentes}</b></span></div>
          </div>
        `).join('');
      }
    }

    async function criarEvento() {
      const nome = document.getElementById('novoNome').value;
      const cols = document.getElementById('novoColunas').value.split(',').map(c=>c.trim()).filter(c=>c);
      const r = await api('criarEvento', {nome, colunas:cols});
      if(r && r.sucesso) { fecharModais(); carregarEventos(); showToast("Criado!"); }
    }

    async function abrirEvento(nome) {
      ESTADO.eventoAtual = nome;
      document.getElementById('tituloEvento').innerText = nome;
      const r = await api('obterEvento', {nomeEvento:nome});
      if(r && r.sucesso) {
        ESTADO.dadosEvento = r.lista;
        ESTADO.colunas = r.colunas;
        renderTabela();
        document.getElementById('modal-evento').classList.remove('hide');
      }
    }

    function renderTabela() {
      const div = document.getElementById('tabela-container');
      if(ESTADO.dadosEvento.length === 0) { div.innerHTML = "<p style='text-align:center;padding:20px;color:#999'>Vazio</p>"; return; }
      
      let html = '<table><thead><tr>';
      ESTADO.colunas.forEach(c => html += `<th>${c}</th>`);
      html += '<th></th></tr></thead><tbody>';
      
      ESTADO.dadosEvento.forEach(p => {
        html += `<tr>`;
        ESTADO.colunas.forEach(c => html += `<td>${c==="Status" && p[c]==="Presente" ? "‚úÖ" : (p[c]||"")}</td>`);
        html += `<td><button onclick="excluirPessoa(${p._linha})" style="background:none;border:none;cursor:pointer">üóëÔ∏è</button></td></tr>`;
      });
      div.innerHTML = html + "</tbody></table>";
    }

    // PESSOAS
    function modalConvidado() {
      const div = document.getElementById('form-pessoa');
      div.innerHTML = '';
      ESTADO.colunas.forEach(c => {
        if(c !== "Status") div.innerHTML += `<label>${c}</label><input class="inp-p" data-col="${c}">`;
      });
      document.getElementById('modal-pessoa').classList.remove('hide');
    }

    async function salvarPessoa() {
      const inputs = document.querySelectorAll('.inp-p');
      let dados = {};
      inputs.forEach(i => dados[i.dataset.col] = i.value);
      const r = await api('adicionarPessoa', {nomeEvento:ESTADO.eventoAtual, dados});
      if(r && r.sucesso) {
        document.getElementById('modal-pessoa').classList.add('hide');
        abrirEvento(ESTADO.eventoAtual);
      }
    }

    async function excluirPessoa(linha) {
      if(confirm("Excluir?")) {
        const r = await api('excluirPessoa', {nomeEvento:ESTADO.eventoAtual, linha});
        if(r) abrirEvento(ESTADO.eventoAtual);
      }
    }
    
    async function excluirEvento() {
      if(confirm("Apagar evento?")) {
        const r = await api('excluirEvento', {nomeEvento:ESTADO.eventoAtual});
        if(r) { fecharModais(); carregarEventos(); }
      }
    }

    // CHECK-IN MODE (M√ÅGICA ACONTECE AQUI)
    function entrarModoCheckin() {
      document.body.classList.add('checkin-active');
      document.getElementById('modal-evento').classList.add('hide');
      document.getElementById('view-dashboard').style.display = 'none';
      document.getElementById('area-checkin').style.display = 'block';
      renderCheckin();
    }

    function sairModoCheckin() {
      document.body.classList.remove('checkin-active');
      document.getElementById('area-checkin').style.display = 'none';
      document.getElementById('view-dashboard').style.display = 'block';
      abrirEvento(ESTADO.eventoAtual); // Recarrega tabela normal
    }

    function renderCheckin() {
      const termo = document.getElementById('buscaCheckin').value.toLowerCase();
      const div = document.getElementById('grid-checkin');
      let presentes = 0;
      
      div.innerHTML = ESTADO.dadosEvento.map(p => {
        const isPres = p["Status"] === "Presente";
        if(isPres) presentes++;
        if(!p["Nome"].toLowerCase().includes(termo)) return '';
        
        return `<div class="guest-card ${isPres ? 'checked' : ''}" onclick="toggleStatus(${p._linha})">
          <div>
            <div class="guest-name">${p["Nome"]}</div>
            <div class="guest-info">${p[ESTADO.colunas[1]] || ""}</div>
          </div>
          <div class="check-btn">‚úì</div>
        </div>`;
      }).join('');
      
      document.getElementById('ck-presentes').innerText = presentes;
      document.getElementById('ck-total').innerText = ESTADO.dadosEvento.length;
    }

    async function toggleStatus(linha) {
      // Otimista
      const p = ESTADO.dadosEvento.find(x => x._linha === linha);
      p["Status"] = p["Status"] === "Presente" ? "Pendente" : "Presente";
      renderCheckin();
      await api('toggleCheckin', {nomeEvento:ESTADO.eventoAtual, linha});
    }

    // UTILS
    function importarXLS(input) {
      const reader = new FileReader();
      reader.onload = async (e) => {
        const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        await api('importarExcel', {nomeEvento:ESTADO.eventoAtual, lista:json});
        abrirEvento(ESTADO.eventoAtual);
      };
      reader.readAsArrayBuffer(input.files[0]);
    }
    
    async function carregarBanco() {
      const r = await api('listarBanco');
      if(r && r.lista) ESTADO.banco = r.lista;
      const tb = document.querySelector('#tabela-banco tbody');
      tb.innerHTML = ESTADO.banco.map(b => `<tr><td>${b.nome}</td><td>${b.info}</td></tr>`).join('');
    }

    function nav(tela) {
      document.getElementById('view-dashboard').classList.add('hide');
      document.getElementById('view-banco').classList.add('hide');
      document.getElementById('view-'+tela).classList.remove('hide');
    }
    
    function abrirModalNovo() { document.getElementById('modal-novo').classList.remove('hide'); }
    function fecharModais() { document.querySelectorAll('.overlay').forEach(m => m.classList.add('hide')); }
    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
  </script>
</body>
</html>
