<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmar Presen√ßa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #eef2f6; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .card-rsvp { max-width: 500px; width: 100%; border: none; shadow: 0 10px 25px rgba(0,0,0,0.1); border-radius: 15px; overflow: hidden; }
        .header-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; padding: 30px 20px; text-align: center; }
        .loading { display: none; text-align: center; padding: 20px; }
    </style>
</head>
<body>

<div class="card-rsvp">
    <div class="header-bg">
        <h2 id="nome-evento-titulo" class="fw-bold mb-0">Carregando evento...</h2>
        <p class="opacity-75 mb-0 mt-2">Confirma√ß√£o de Presen√ßa</p>
    </div>

    <div class="card-body p-4 bg-white">
        
        <div id="loading" class="loading">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Verificando...</p>
        </div>

        <div id="passo-1">
            <p class="text-center text-muted mb-4">Por favor, digite seu nome exatamente como est√° no convite para liberar seu acesso.</p>
            
            <form onsubmit="verificarNome(event)">
                <div class="mb-3">
                    <label class="form-label fw-bold">Seu Nome</label>
                    <input type="text" id="input-nome-busca" class="form-control form-control-lg text-center" placeholder="Ex: Gabriel Felizardo" required>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg rounded-pill">
                        Verificar na Lista <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </form>
        </div>

        <div id="passo-2" style="display:none;">
            <div class="alert alert-success border-0 text-center">
                <i class="fas fa-check-circle me-1"></i> Ol√°, <strong id="nome-encontrado"></strong>!
            </div>
            
            <form onsubmit="enviarResposta(event)">
                <input type="hidden" id="linha-convidado">
                
                <div class="mb-4 text-center">
                    <label class="form-label fw-bold d-block mb-3">Voc√™ poder√° comparecer?</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="resp-Status" id="status-sim" value="Confirmado" checked>
                        <label class="btn btn-outline-success py-3" for="status-sim">Sim, eu vou! üéâ</label>

                        <input type="radio" class="btn-check" name="resp-Status" id="status-nao" value="N√£o vai">
                        <label class="btn btn-outline-danger py-3" for="status-nao">N√£o poderei ir üò¢</label>
                    </div>
                </div>

                <div id="perguntas-extras"></div>

                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-primary btn-lg rounded-pill">
                        Confirmar Presen√ßa
                    </button>
                </div>
            </form>
        </div>

        <div id="passo-3" style="display:none;" class="text-center py-4">
            <div class="mb-3">
                <i class="fas fa-check-circle text-success fa-5x"></i>
            </div>
            <h3 class="fw-bold text-dark">Obrigado!</h3>
            <p class="text-muted">Sua resposta foi registrada com sucesso.</p>
        </div>

    </div>
</div>

<script>
    // ============================================================
    // CONFIGURA√á√ÉO
    // ============================================================
    const API_URL = "https://script.google.com/macros/s/AKfycbznlB0UzqjzlkneSPFv1mi_0Jqqtv6DkZsbPctw28isyZvAwyXOBv2tHnQUl1SM1QQ/exec"; 

    // Pega o nome do evento da URL (?evento=Nome)
    const urlParams = new URLSearchParams(window.location.search);
    const eventoNome = urlParams.get('evento');

    if (eventoNome) {
        document.getElementById('nome-evento-titulo').innerText = eventoNome;
    } else {
        document.getElementById('nome-evento-titulo').innerText = "Evento n√£o especificado";
        alert("Erro: Link incompleto. Falta o nome do evento.");
    }

    async function chamarAPI(acao, dados = {}) {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('passo-1').style.display = 'none';
        
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ acao: acao, ...dados })
            });
            const json = await response.json();
            document.getElementById('loading').style.display = 'none';
            return json;
        } catch (e) {
            alert("Erro de conex√£o.");
            document.getElementById('loading').style.display = 'none';
            document.getElementById('passo-1').style.display = 'block';
            return null;
        }
    }

    async function verificarNome(e) {
        e.preventDefault();
        const nomeBusca = document.getElementById('input-nome-busca').value;
        
        const res = await chamarAPI('buscarConvidado', { nomeEvento: eventoNome, nomeBusca: nomeBusca });
        
        if (res && res.encontrado) {
            document.getElementById('nome-encontrado').innerText = res.nomeCompleto;
            document.getElementById('linha-convidado').value = res.linha;
            gerarFormulario(res.colunas, res.dadosAtuais);
            
            // Troca de tela
            document.getElementById('passo-1').style.display = 'none';
            document.getElementById('passo-2').style.display = 'block';
        } else {
            alert("Nome n√£o encontrado na lista deste evento. Tente digitar apenas o primeiro nome.");
            document.getElementById('passo-1').style.display = 'block';
        }
    }

    function gerarFormulario(colunas, dadosAtuais) {
        const container = document.getElementById('perguntas-extras');
        container.innerHTML = "";

        colunas.forEach((col, index) => {
            // Ignora colunas padr√£o que j√° tratamos ou n√£o queremos mostrar
            if (col === "Nome" || col === "Status" || col === "Telefone" || col === "Email") return;

            const valorAtual = dadosAtuais[index];
            const div = document.createElement('div');
            div.className = "mb-3";
            
            div.innerHTML = `
                <label class="form-label fw-bold">${col}</label>
                <input type="text" class="form-control" name="extra-${col}" value="${valorAtual}" placeholder="Sua resposta...">
            `;
            container.appendChild(div);
        });
    }

    async function enviarResposta(e) {
        e.preventDefault();
        
        const linha = document.getElementById('linha-convidado').value;
        const status = document.querySelector('input[name="resp-Status"]:checked').value;
        
        // Coleta respostas extras
        let respostas = { "Status": status };
        
        // Pega todos os inputs extras gerados
        const inputsExtras = document.querySelectorAll('input[name^="extra-"]');
        inputsExtras.forEach(input => {
            const nomeColuna = input.name.replace("extra-", "");
            respostas[nomeColuna] = input.value;
        });

        const res = await chamarAPI('salvarResposta', { 
            nomeEvento: eventoNome, 
            linha: linha, 
            respostas: respostas 
        });

        if (res && res.sucesso) {
            document.getElementById('passo-2').style.display = 'none';
            document.getElementById('passo-3').style.display = 'block';
        }
    }
</script>

</body>
</html>
