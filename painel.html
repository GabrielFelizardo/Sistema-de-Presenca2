<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Eventos v16.2 - Multi-Usu√°rio</title>
  
  <!-- XLSX Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      display: flex;
      min-height: 100vh;
    }
    
    /* SIDEBAR */
    .sidebar {
      width: 280px;
      background: white;
      padding: 20px;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }
    
    .sidebar h2 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 24px;
    }
    
    .sidebar .version {
      font-size: 12px;
      color: #999;
      margin-bottom: 20px;
    }
    
    /* USER INFO */
    .user-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }
    
    .user-info small {
      color: #666;
      font-size: 11px;
      text-transform: uppercase;
    }
    
    .user-info #user-email-display {
      font-weight: bold;
      color: #333;
      font-size: 13px;
      margin-top: 5px;
      word-break: break-all;
    }
    
    .user-info .btn-logout {
      margin-top: 10px;
      width: 100%;
      padding: 8px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    
    .user-info .btn-logout:hover {
      background: #c82333;
    }
    
    /* MENU */
    .menu {
      flex: 1;
    }
    
    .aba-btn {
      width: 100%;
      padding: 12px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      font-size: 14px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .aba-btn:hover {
      background: #e9ecef;
      transform: translateX(5px);
    }
    
    .aba-btn.ativa {
      background: #667eea;
      color: white;
      font-weight: bold;
    }
    
    /* MAIN CONTENT */
    .main-content {
      flex: 1;
      padding: 40px;
      overflow-y: auto;
    }
    
    .aba-conteudo {
      display: none;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .aba-conteudo.ativa {
      display: block;
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    
    /* BUTTONS */
    .btn-primary {
      background: #667eea;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #667eea;
      color: white;
    }
    
    /* CARDS */
    .evento-card, .template-card, .nome-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
    }
    
    .evento-card h3, .template-card h4, .nome-card h4 {
      margin-bottom: 10px;
      color: #333;
    }
    
    .evento-card button, .template-card button, .nome-card button {
      margin-right: 10px;
      margin-top: 10px;
    }
    
    /* TABLE */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    th {
      background: #667eea;
      color: white;
      font-weight: 600;
    }
    
    tr:hover {
      background: #f8f9fa;
    }
    
    /* FORMS */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h2 {
      color: #333;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    
    /* TOAST */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      z-index: 2000;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .toast.sucesso {
      background: #28a745;
    }
    
    .toast.erro {
      background: #dc3545;
    }
    
    .toast.info {
      background: #17a2b8;
    }
    
    /* LOADING */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }
    
    .loading-overlay.active {
      display: flex;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* PAGINATION */
    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .pagination button {
      padding: 8px 16px;
    }
    
    /* RESPONSIVE */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
      }
      
      .main-content {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  
  <div class="container">
    
    <!-- SIDEBAR -->
    <div class="sidebar">
      <h2>üéâ RSVP System</h2>
      <div class="version">v16.2 Multi-Usu√°rio</div>
      
      <!-- USER INFO -->
      <div class="user-info">
        <small>Logado como:</small>
        <p id="user-email-display">Carregando...</p>
        <button class="btn-logout" onclick="fazerLogout()">üö™ Sair</button>
      </div>
      
      <!-- MENU -->
      <div class="menu">
        <button class="aba-btn ativa" onclick="trocarAba('eventos')">
          üìã Meus Eventos
        </button>
        <button class="aba-btn" onclick="trocarAba('gerenciar')">
          üë• Gerenciar Evento
        </button>
        <button class="aba-btn" onclick="trocarAba('templates')">
          üìë Templates
        </button>
        <button class="aba-btn" onclick="trocarAba('banco')">
          üìá Banco de Nomes
        </button>
        <button class="aba-btn" onclick="trocarAba('manual')">
          üìñ Manual de Uso
        </button>
      </div>
    </div>
    
    <!-- MAIN CONTENT -->
    <div class="main-content">
      
      <!-- ABA: EVENTOS -->
      <div id="eventos" class="aba-conteudo ativa">
        <h1>Meus Eventos</h1>
        <p class="subtitle">Gerencie todos os seus eventos em um s√≥ lugar</p>
        
        <button class="btn-primary" onclick="abrirModal('modal-novo-evento')">
          ‚ûï Criar Novo Evento
        </button>
        
        <div id="lista-eventos" style="margin-top: 30px;">
          <!-- Preenchido via JavaScript -->
        </div>
      </div>
      
      <!-- ABA: GERENCIAR -->
      <div id="gerenciar" class="aba-conteudo">
        <h1 id="nome-evento-atual">Selecione um evento</h1>
        <p class="subtitle">Gerencie convidados e envie convites</p>
        
        <div style="margin-bottom: 20px;">
          <button class="btn-primary" onclick="abrirModal('modal-adicionar')">‚ûï Adicionar Convidado</button>
          <button class="btn-primary" onclick="abrirModal('modal-importar')">üì• Importar Excel</button>
          <button class="btn-primary" onclick="abrirModal('modal-enviar-emails')">üìß Enviar Emails</button>
          <button class="btn-secondary" onclick="salvarTemplateAtual()">üíæ Salvar como Template</button>
        </div>
        
        <table id="tabela-convidados">
          <thead><tr></tr></thead>
          <tbody></tbody>
        </table>
        
        <div class="pagination">
          <button onclick="paginaAnterior()">‚¨ÖÔ∏è Anterior</button>
          <span id="info-paginacao">P√°gina 1 de 1</span>
          <button onclick="proximaPagina()">Pr√≥xima ‚û°Ô∏è</button>
        </div>
      </div>
      
      <!-- ABA: TEMPLATES -->
      <div id="templates" class="aba-conteudo">
        <h1>Templates Salvos</h1>
        <p class="subtitle">Reutilize estruturas de eventos anteriores</p>
        
        <div id="lista-templates">
          <!-- Preenchido via JavaScript -->
        </div>
      </div>
      
      <!-- ABA: BANCO DE NOMES -->
      <div id="banco" class="aba-conteudo">
        <h1>Banco de Nomes</h1>
        <p class="subtitle">Gerencie sua lista de contatos</p>
        
        <div style="margin-bottom: 20px;">
          <button class="btn-primary" onclick="abrirModal('modal-adicionar-banco')">‚ûï Adicionar Contato</button>
          <button class="btn-secondary" onclick="migrarParaBanco()">üîÑ Migrar de Eventos</button>
        </div>
        
        <div class="form-group">
          <input type="text" id="busca-banco" placeholder="Buscar por nome...">
          <button class="btn-primary" onclick="buscarNoBanco()" style="margin-top: 10px;">üîç Buscar</button>
        </div>
        
        <div id="lista-banco-nomes" style="margin-top: 20px;">
          <!-- Preenchido via JavaScript -->
        </div>
      </div>
      
      <!-- ABA: MANUAL -->
      <div id="manual" class="aba-conteudo">
        <h1>Manual de Uso</h1>
        
        <h2 style="margin-top: 20px;">1Ô∏è‚É£ Como Criar um Evento</h2>
        <p>Clique em "Criar Novo Evento", escolha um template ou importe dados do Excel.</p>
        
        <h2 style="margin-top: 20px;">2Ô∏è‚É£ Como Adicionar Convidados</h2>
        <p>Use o bot√£o "Adicionar Convidado" ou importe uma planilha Excel completa.</p>
        
        <h2 style="margin-top: 20px;">3Ô∏è‚É£ Como Enviar Convites</h2>
        <p>Selecione os convidados na tabela e clique em "Enviar Emails".</p>
        
        <h2 style="margin-top: 20px;">4Ô∏è‚É£ Templates</h2>
        <p>Salve a estrutura de um evento como template para reutilizar depois.</p>
        
        <h2 style="margin-top: 20px;">5Ô∏è‚É£ Banco de Nomes</h2>
        <p>Mantenha uma lista de contatos que aparecem em v√°rios eventos.</p>
      </div>
      
    </div>
  </div>
  
  <!-- MODAIS -->
  
  <!-- Modal: Novo Evento -->
  <div id="modal-novo-evento" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Criar Novo Evento</h2>
        <button class="close-modal" onclick="fecharModal('modal-novo-evento')">√ó</button>
      </div>
      
      <div class="form-group">
        <label>Nome do Evento:</label>
        <input type="text" id="nome-evento" placeholder="Ex: Casamento Jo√£o e Maria">
      </div>
      
      <div class="form-group">
        <label>Template:</label>
        <select id="tipo-evento">
          <option value="Basico">B√°sico</option>
          <option value="Casamento">Casamento</option>
          <option value="Corporativo">Corporativo</option>
          <option value="Infantil">Infantil</option>
          <option value="Formatura">Formatura</option>
          <option value="Workshop">Workshop</option>
          <option value="Jantar">Jantar</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Ou cole dados do Excel (opcional):</label>
        <textarea id="dados-importacao" placeholder="Cole aqui dados copiados do Excel..."></textarea>
      </div>
      
      <button class="btn-primary" onclick="criarEvento()">Criar Evento</button>
    </div>
  </div>
  
  <!-- Modal: Adicionar Convidado -->
  <div id="modal-adicionar" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Adicionar Convidado</h2>
        <button class="close-modal" onclick="fecharModal('modal-adicionar')">√ó</button>
      </div>
      
      <form id="form-convidado">
        <!-- Preenchido dinamicamente -->
      </form>
      
      <button class="btn-primary" onclick="adicionarConvidadoManual()">Adicionar</button>
    </div>
  </div>
  
  <!-- Modal: Importar Excel -->
  <div id="modal-importar" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Importar Excel</h2>
        <button class="close-modal" onclick="fecharModal('modal-importar')">√ó</button>
      </div>
      
      <div class="form-group">
        <label>Selecione o arquivo Excel:</label>
        <input type="file" id="arquivo-excel" accept=".xlsx,.xls">
      </div>
      
      <button class="btn-primary" onclick="importarExcel()">Importar</button>
    </div>
  </div>
  
  <!-- Modal: Enviar Emails -->
  <div id="modal-enviar-emails" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Enviar Emails</h2>
        <button class="close-modal" onclick="fecharModal('modal-enviar-emails')">√ó</button>
      </div>
      
      <div class="form-group">
        <label>Assunto:</label>
        <input type="text" id="email-assunto" placeholder="Voc√™ est√° convidado!">
      </div>
      
      <div class="form-group">
        <label>Mensagem:</label>
        <textarea id="email-mensagem" placeholder="Ol√° {Nome}, voc√™ est√° convidado..."></textarea>
      </div>
      
      <p><small>Use {Nome} para personalizar, {Link} para adicionar link de confirma√ß√£o</small></p>
      
      <button class="btn-primary" onclick="enviarEmailsSelecionados()">Enviar</button>
    </div>
  </div>
  
  <!-- Modal: Adicionar ao Banco -->
  <div id="modal-adicionar-banco" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Adicionar ao Banco de Nomes</h2>
        <button class="close-modal" onclick="fecharModal('modal-adicionar-banco')">√ó</button>
      </div>
      
      <div class="form-group">
        <label>Nome:</label>
        <input type="text" id="banco-nome">
      </div>
      
      <div class="form-group">
        <label>Email:</label>
        <input type="email" id="banco-email">
      </div>
      
      <div class="form-group">
        <label>Telefone:</label>
        <input type="text" id="banco-telefone">
      </div>
      
      <button class="btn-primary" onclick="adicionarAoBancoManual()">Adicionar</button>
    </div>
  </div>
  
  <!-- TOAST -->
  <div id="toast" class="toast"></div>
  
  <!-- LOADING -->
  <div id="loading" class="loading-overlay">
    <div class="spinner"></div>
  </div>
  
  <script>
    // =======================================================================
    // JAVASCRIPT v16.2 - MULTI-USU√ÅRIO
    // =======================================================================
    
    // ‚ö†Ô∏è CONFIGURE AQUI:
    const API_URL = "https://script.google.com/macros/s/AKfycbxP4A0toTethYfDbizUoqgzcfMNLEM3GRcvqEfQcctREorhBLyVj6SNbBif0YgHQ5a_/exec";
    
    // =======================================================================
    // VARI√ÅVEIS GLOBAIS + AUTENTICA√á√ÉO
    // =======================================================================
    
    let usuarioEmail = null;
    let usuarioPlanilha = null;
    
    // Verificar login ao carregar p√°gina
    window.addEventListener('DOMContentLoaded', function() {
      verificarLogin();
    });
    
    function verificarLogin() {
      // Buscar dados da sess√£o
      usuarioEmail = sessionStorage.getItem('rsvp_user_email');
      usuarioPlanilha = sessionStorage.getItem('rsvp_user_planilha');
      const novoUsuario = sessionStorage.getItem('rsvp_user_novo');
      
      // Se n√£o tem sess√£o, redirecionar para login
      if (!usuarioEmail || !usuarioPlanilha) {
        window.location.href = 'login.html';
        return;
      }
      
      // Exibir email do usu√°rio na interface
      const userEmailElement = document.getElementById('user-email-display');
      if (userEmailElement) {
        userEmailElement.textContent = usuarioEmail;
      }
      
      // Se √© novo usu√°rio, mostrar mensagem de boas-vindas
      if (novoUsuario === 'true') {
        mostrarToast('üéâ Bem-vindo! Sua planilha foi criada com sucesso.', 'sucesso');
        sessionStorage.removeItem('rsvp_user_novo');
      }
      
      // Carregar eventos ap√≥s verificar login
      carregarEventos();
    }
    
    function fazerLogout() {
      // Limpar sess√£o
      sessionStorage.removeItem('rsvp_user_email');
      sessionStorage.removeItem('rsvp_user_planilha');
      sessionStorage.removeItem('rsvp_user_novo');
      
      // Redirecionar para login
      mostrarToast('Logout realizado com sucesso', 'sucesso');
      setTimeout(() => {
        window.location.href = 'login.html';
      }, 1000);
    }
    
    // =======================================================================
    // FUN√á√ÉO CENTRAL DE API - v16.2
    // =======================================================================
    
    async function chamarAPI(acao, dados = {}) {
      // ‚úÖ SEMPRE incluir email automaticamente
      const dadosCompletos = {
        acao: acao,
        email: usuarioEmail,
        ...dados
      };
      
      try {
        const resposta = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify(dadosCompletos)
        });
        
        const resultado = await resposta.json();
        
        if (resultado.erro) {
          throw new Error(resultado.erro);
        }
        
        return resultado;
        
      } catch (erro) {
        console.error('Erro na API:', erro);
        mostrarToast('‚ùå Erro: ' + erro.message, 'erro');
        throw erro;
      }
    }
    
    // =======================================================================
    // VARI√ÅVEIS GLOBAIS
    // =======================================================================
    
    let eventoAtual = null;
    let dadosAtuais = [];
    let headersColunas = [];
    let paginaAtual = 1;
    const LINHAS_POR_PAGINA = 10;
    
    // =======================================================================
    // FUN√á√ïES DE UI
    // =======================================================================
    
    function mostrarToast(mensagem, tipo = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = mensagem;
      toast.className = 'toast show ' + tipo;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    function mostrarLoading() {
      document.getElementById('loading').classList.add('active');
    }
    
    function esconderLoading() {
      document.getElementById('loading').classList.remove('active');
    }
    
    function trocarAba(aba) {
      // Esconder todas
      document.querySelectorAll('.aba-conteudo').forEach(el => {
        el.classList.remove('ativa');
      });
      
      // Remover classe ativa dos bot√µes
      document.querySelectorAll('.aba-btn').forEach(btn => {
        btn.classList.remove('ativa');
      });
      
      // Mostrar aba selecionada
      document.getElementById(aba).classList.add('ativa');
      
      // Ativar bot√£o
      event.target.classList.add('ativa');
      
      // Carregar dados
      if (aba === 'eventos') {
        carregarEventos();
      } else if (aba === 'templates') {
        carregarTemplates();
      } else if (aba === 'banco') {
        carregarBancoNomes();
      }
    }
    
    function abrirModal(id) {
      document.getElementById(id).classList.add('active');
      
      // Se for modal de adicionar convidado, gerar form
      if (id === 'modal-adicionar' && headersColunas.length > 0) {
        const form = document.getElementById('form-convidado');
        form.innerHTML = '';
        
        headersColunas.forEach(col => {
          const div = document.createElement('div');
          div.className = 'form-group';
          div.innerHTML = `
            <label>${col}:</label>
            <input type="text" placeholder="${col}">
          `;
          form.appendChild(div);
        });
      }
    }
    
    function fecharModal(id) {
      document.getElementById(id).classList.remove('active');
    }
    
    // =======================================================================
    // GEST√ÉO DE EVENTOS
    // =======================================================================
    
    async function carregarEventos() {
      mostrarLoading();
      try {
        const resultado = await chamarAPI('listarEventos');
        
        const lista = document.getElementById('lista-eventos');
        lista.innerHTML = '';
        
        if (!resultado || resultado.length === 0) {
          lista.innerHTML = '<p style="text-align:center;color:#666;padding:40px;">Nenhum evento criado ainda. Clique em "Criar Novo Evento" para come√ßar!</p>';
          return;
        }
        
        resultado.forEach(evento => {
          const div = document.createElement('div');
          div.className = 'evento-card';
          div.innerHTML = `
            <h3>${evento.nome}</h3>
            <button onclick="abrirEvento('${evento.nome.replace(/'/g, "\\'")}')">Abrir Evento</button>
            <button class="btn-danger" onclick="confirmarExclusaoEvento('${evento.nome.replace(/'/g, "\\'")}')">Excluir</button>
          `;
          lista.appendChild(div);
        });
        
      } catch (erro) {
        console.error('Erro ao carregar eventos:', erro);
      } finally {
        esconderLoading();
      }
    }
    
    async function criarEvento() {
      const nome = document.getElementById('nome-evento').value.trim();
      const tipo = document.getElementById('tipo-evento').value;
      const dadosImportados = document.getElementById('dados-importacao').value;
      
      if (!nome) {
        mostrarToast('Digite o nome do evento', 'erro');
        return;
      }
      
      mostrarLoading();
      try {
        await chamarAPI('criarNovoEvento', {
          nome: nome,
          template: tipo,
          dadosImportados: dadosImportados || null
        });
        
        mostrarToast('‚úÖ Evento criado com sucesso!', 'sucesso');
        document.getElementById('nome-evento').value = '';
        document.getElementById('dados-importacao').value = '';
        fecharModal('modal-novo-evento');
        carregarEventos();
        
      } catch (erro) {
        console.error('Erro ao criar evento:', erro);
      } finally {
        esconderLoading();
      }
    }
    
    async function abrirEvento(nomeEvento) {
      eventoAtual = nomeEvento;
      paginaAtual = 1;
      mostrarLoading();
      
      try {
        const resultado = await chamarAPI('obterDadosEvento', {
          nomeEvento: nomeEvento
        });
        
        headersColunas = resultado.headers;
        dadosAtuais = resultado.rows;
        
        document.getElementById('nome-evento-atual').textContent = nomeEvento;
        renderizarTabela();
        trocarAba('gerenciar');
        
      } catch (erro) {
        console.error('Erro ao abrir evento:', erro);
      } finally {
        esconderLoading();
      }
    }
    
    function renderizarTabela() {
      const thead = document.querySelector('#tabela-convidados thead tr');
      const tbody = document.querySelector('#tabela-convidados tbody');
      
      thead.innerHTML = '';
      tbody.innerHTML = '';
      
      // Headers
      headersColunas.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col;
        thead.appendChild(th);
      });
      
      const thAcoes = document.createElement('th');
      thAcoes.textContent = 'A√ß√µes';
      thead.appendChild(thAcoes);
      
      // Dados com pagina√ß√£o
      const inicio = (paginaAtual - 1) * LINHAS_POR_PAGINA;
      const fim = inicio + LINHAS_POR_PAGINA;
      const dadosPagina = dadosAtuais.slice(inicio, fim);
      
      dadosPagina.forEach((linha, indexLocal) => {
        const indexReal = inicio + indexLocal;
        const tr = document.createElement('tr');
        
        linha.forEach(celula => {
          const td = document.createElement('td');
          td.textContent = celula || '';
          tr.appendChild(td);
        });
        
        const tdAcoes = document.createElement('td');
        tdAcoes.innerHTML = `
          <button class="btn-sm" onclick="editarConvidado(${indexReal})">‚úèÔ∏è</button>
          <button class="btn-sm btn-danger" onclick="excluirConvidado(${indexReal})">üóëÔ∏è</button>
        `;
        tr.appendChild(tdAcoes);
        
        tbody.appendChild(tr);
      });
      
      const totalPaginas = Math.ceil(dadosAtuais.length / LINHAS_POR_PAGINA);
      document.getElementById('info-paginacao').textContent = 
        `P√°gina ${paginaAtual} de ${totalPaginas} | Total: ${dadosAtuais.length} convidados`;
    }
    
    function proximaPagina() {
      const totalPaginas = Math.ceil(dadosAtuais.length / LINHAS_POR_PAGINA);
      if (paginaAtual < totalPaginas) {
        paginaAtual++;
        renderizarTabela();
      }
    }
    
    function paginaAnterior() {
      if (paginaAtual > 1) {
        paginaAtual--;
        renderizarTabela();
      }
    }
    
    async function adicionarConvidadoManual() {
      const form = document.getElementById('form-convidado');
      const inputs = form.querySelectorAll('input');
      const dados = [];
      
      inputs.forEach(input => {
        dados.push(input.value.trim());
      });
      
      mostrarLoading();
      try {
        await chamarAPI('adicionarConvidado', {
          nomeEvento: eventoAtual,
          arrayDados: dados
        });
        
        mostrarToast('‚úÖ Convidado adicionado!', 'sucesso');
        fecharModal('modal-adicionar');
        abrirEvento(eventoAtual);
        
      } catch (erro) {
        console.error('Erro ao adicionar:', erro);
      } finally {
        esconderLoading();
      }
    }
    
    async function excluirConvidado(index) {
      if (!confirm('Excluir este convidado?')) return;
      
      mostrarLoading();
      try {
        await chamarAPI('excluirConvidado', {
          nomeEvento: eventoAtual,
          linha: index + 2
        });
        
        mostrarToast('‚úÖ Convidado exclu√≠do', 'sucesso');
        abrirEvento(eventoAtual);
        
      } catch (erro) {
        console.error('Erro ao excluir:', erro);
      } finally {
        esconderLoading();
      }
    }
    
    async function confirmarExclusaoEvento(nomeEvento) {
      if (!confirm(`Excluir evento "${nomeEvento}"? Esta a√ß√£o n√£o pode ser desfeita.`)) return;
      
      mostrarLoading();
      try {
        await chamarAPI('excluirEvento', {
          nomeEvento: nomeEvento
        });
        
        mostrarToast('‚úÖ Evento exclu√≠do', 'sucesso');
        carregarEventos();
        
      } catch (erro) {
        console.error('Erro ao excluir evento:', erro);
      } finally {
        esconderLoading();
      }
    }
    
    // =======================================================================
    // IMPORTA√á√ÉO EXCEL
    // =======================================================================
    
    function importarExcel() {
      const input = document.getElementById('arquivo-excel');
      const file = input.files[0];
      
      if (!file) {
        mostrarToast('Selecione um arquivo', 'erro');
        return;
      }
      
      const reader = new FileReader();
      
      reader.onload = async function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const primeiraAba = workbook.Sheets[workbook.SheetNames[0]];
          const matriz = XLSX.utils.sheet_to_json(primeiraAba, { header: 1 });
          
          mostrarLoading();
          
          const resultado = await chamarAPI('importarListaConvidados', {
            nomeEvento: eventoAtual,
            matrizDados: matriz,
            temCabecalho: true
          });
          
          mostrarToast(`‚úÖ ${resultado.qtd} convidados importados!`, 'sucesso');
          fecharModal('modal-importar');
          abrirEvento(eventoAtual);
          
        } catch (erro) {
          console.error('Erro ao importar:', erro);
          mostrarToast('‚ùå Erro ao importar arquivo', 'erro');
        } finally {
          esconderLoading();
        }
      };
      
      reader.readAsArrayBuffer(file);
    }
    
    // =======================================================================
    // ENVIO DE EMAILS
    // =======================================================================
    
    async function enviarEmailsSelecionados() {
      // Implementa√ß√£o simplificada
      mostrarToast('Fun√ß√£o de envio de emails em desenvolvimento', 'info');
    }
    
    // =======================================================================
    // TEMPLATES
    // =======================================================================
    
    async function carregarTemplates() {
      mostrarLoading();
      try {
        const resultado = await chamarAPI('listarTemplates');
        
        const lista = document.getElementById('lista-templates');
        lista.innerHTML = '';
        
        if (!resultado.templates || resultado.templates.length === 0) {
          lista.innerHTML = '<p style="text-align:center;color:#666;padding:40px;">Nenhum template salvo ainda.</p>';
          return;
        }
        
        resultado.templates.forEach(template => {
          const div = document.createElement('div');
          div.className = 'template-card';
          div.innerHTML = `
            <h4>${template.nome}</h4>
            <p>Colunas: ${template.colunas.join(', ')}</p>
            <p>Usado: ${template.vezesUsado} vezes</p>
            <button onclick="usarTemplate('${template.nome.replace(/'/g, "\\'")}')">Usar Template</button>
            <button class="btn-danger" onclick="excluirTemplate('${template.nome.replace(/'/g, "\\'")}')">Excluir</button>
          `;
          lista.appendChild(div);
        });
        
      } catch (erro) {
        console.error('Erro ao carregar templates:', erro);
      } finally {
        esconderLoading();
      }
    }
    
    async function salvarTemplateAtual() {
      const nome = prompt('Nome do template:');
      if (!nome || !eventoAtual) return;
      
      mostrarLoading();
      try {
        await chamarAPI('salvarTemplate', {
          nomeTemplate: nome,
          colunas: headersColunas,
          emailAssunto: '',
          emailMensagem: ''
        });
        
        mostrarToast('‚úÖ Template salvo!', 'sucesso');
        
      } catch (erro) {
        console.error('Erro ao salvar template:', erro);
      } finally {
        esconderLoading();
      }
    }
    
    async function usarTemplate(nomeTemplate) {
      const nomeEvento = prompt('Nome do novo evento:');
      if (!nomeEvento) return;
      
      mostrarLoading();
      try {
        await chamarAPI('criarEventoDeTemplate', {
          nomeEvento: nomeEvento,
          nomeTemplate: nomeTemplate,
          usarEmail: false
        });
        
        mostrarToast('‚úÖ Evento criado a partir do template!', 'sucesso');
        carregarEventos();
        
      } catch (erro) {
        console.error('Erro ao usar template:', erro);
      } finally {
        esconderLoading();
      }
    }
    
    async function excluirTemplate(nomeTemplate) {
      if (!confirm(`Excluir template "${nomeTemplate}"?`)) return;
      
      mostrarLoading();
      try {
        await chamarAPI('excluirTemplate', {
          nomeTemplate: nomeTemplate
        });
        
        mostrarToast('‚úÖ Template exclu√≠do', 'sucesso');
        carregarTemplates();
        
      } catch (erro) {
        console.error('Erro ao excluir template:', erro);
      } finally {
        esconderLoading();
      }
    }
    
    // =======================================================================
    // BANCO DE NOMES
    // =======================================================================
    
    async function carregarBancoNomes() {
      mostrarLoading();
      try {
        const resultado = await chamarAPI('listarBancoNomes');
        
        const lista = document.getElementById('lista-banco-nomes');
        lista.innerHTML = '';
        
        if (!resultado.nomes || resultado.nomes.length === 0) {
          lista.innerHTML = '<p style="text-align:center;color:#666;padding:40px;">Banco de nomes vazio.</p>';
          return;
        }
        
        resultado.nomes.forEach(pessoa => {
          const div = document.createElement('div');
          div.className = 'nome-card';
          div.innerHTML = `
            <h4>${pessoa.nome}</h4>
            <p>üìß ${pessoa.email || 'Sem email'}</p>
            <p>üì± ${pessoa.telefone || 'Sem telefone'}</p>
            <p>üé´ ${pessoa.totalEventos} eventos</p>
            <button class="btn-sm" onclick="alert('Edi√ß√£o em desenvolvimento')">‚úèÔ∏è Editar</button>
            <button class="btn-sm btn-danger" onclick="excluirDoBanco('${pessoa.nome.replace(/'/g, "\\'")}')">üóëÔ∏è</button>
          `;
          lista.appendChild(div);
        });
        
      } catch (erro) {
        console.error('Erro ao carregar banco:', erro);
      } finally {
        esconderLoading();
      }
    }
    
    async function buscarNoBanco() {
      const termo = document.getElementById('busca-banco').value.trim();
      
      if (!termo) {
        mostrarToast('Digite um nome para buscar', 'erro');
        return;
      }
      
      mostrarLoading();
      try {
        const resultado = await chamarAPI('buscarNoBanco', {
          termo: termo
        });
        
        if (!resultado.encontrado) {
          mostrarToast('Nenhum resultado encontrado', 'info');
          return;
        }
        
        const primeiro = resultado.resultados[0];
        alert(`Encontrado:\n${primeiro.nome}\n${primeiro.email}\n${primeiro.telefone}`);
        
      } catch (erro) {
        console.error('Erro na busca:', erro);
      } finally {
        esconderLoading();
      }
    }
    
    async function adicionarAoBancoManual() {
      const nome = document.getElementById('banco-nome').value.trim();
      const emailContato = document.getElementById('banco-email').value.trim();
      const telefone = document.getElementById('banco-telefone').value.trim();
      
      if (!nome) {
        mostrarToast('Digite o nome', 'erro');
        return;
      }
      
      mostrarLoading();
      try {
        await chamarAPI('adicionarAoBanco', {
          nome: nome,
          emailContato: emailContato,
          telefone: telefone,
          eventoAtual: eventoAtual || 'Manual'
        });
        
        mostrarToast('‚úÖ Adicionado ao banco!', 'sucesso');
        document.getElementById('banco-nome').value = '';
        document.getElementById('banco-email').value = '';
        document.getElementById('banco-telefone').value = '';
        fecharModal('modal-adicionar-banco');
        carregarBancoNomes();
        
      } catch (erro) {
        console.error('Erro ao adicionar ao banco:', erro);
      } finally {
        esconderLoading();
      }
    }
    
    async function excluirDoBanco(nome) {
      if (!confirm(`Excluir "${nome}" do banco?`)) return;
      
      mostrarLoading();
      try {
        await chamarAPI('excluirDoBanco', {
          nome: nome
        });
        
        mostrarToast('‚úÖ Exclu√≠do do banco', 'sucesso');
        carregarBancoNomes();
        
      } catch (erro) {
        console.error('Erro ao excluir:', erro);
      } finally {
        esconderLoading();
      }
    }
    
    async function migrarParaBanco() {
      if (!confirm('Migrar todos os convidados dos eventos para o banco de nomes?')) return;
      
      mostrarLoading();
      try {
        const resultado = await chamarAPI('migrarEventosParaBanco');
        
        mostrarToast(`‚úÖ ${resultado.total} pessoas migradas!`, 'sucesso');
        carregarBancoNomes();
        
      } catch (erro) {
        console.error('Erro na migra√ß√£o:', erro);
      } finally {
        esconderLoading();
      }
    }
    
    // =======================================================================
    // FUN√á√ïES AUXILIARES
    // =======================================================================
    
    function editarConvidado(index) {
      alert('Fun√ß√£o de edi√ß√£o em desenvolvimento');
    }
    
  </script>
</body>
</html>
