<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Eventos - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .sidebar { height: 100vh; background: white; border-right: 1px solid #dee2e6; position: fixed; width: 250px; z-index: 100;}
        .content { margin-left: 250px; padding: 20px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; }
        textarea.form-control { font-family: monospace; font-size: 0.85rem; background-color: #fafafa; }
        .btn-action { width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; }
        .btn-action:hover { transform: scale(1.1); }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary" role="status"></div>
    <span class="mt-3 fw-bold text-secondary">Carregando...</span>
</div>

<div class="sidebar p-4 d-flex flex-column shadow-sm">
    <h5 class="text-primary mb-4 fw-bold"><i class="fas fa-calendar-check me-2"></i>Gestor RSVP</h5>
    <div class="d-grid gap-2">
        <button class="btn btn-light text-start active fw-semibold shadow-sm" onclick="mostrarTela('dashboard')">
            <i class="fas fa-list me-2 text-primary"></i>Meus Eventos
        </button>
        <button class="btn btn-light text-start fw-semibold shadow-sm" onclick="mostrarTela('novo')">
            <i class="fas fa-plus me-2 text-success"></i>Novo Evento
        </button>
    </div>
    <div class="mt-auto text-muted small pt-3 border-top">v7.0 - Com Edi√ß√£o</div>
</div>

<div class="content">
    
    <div id="tela-dashboard">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
            <h3 class="fw-bold text-dark m-0">Painel de Controle</h3>
            <div class="card p-2 shadow-sm border-0 bg-white d-flex flex-row gap-2 align-items-center">
                <select id="select-eventos" class="form-select border-0 fw-bold text-primary" style="min-width: 250px;" onchange="carregarEventoEspecifico()">
                    <option value="">Carregando eventos...</option>
                </select>
                <button class="btn btn-light text-secondary rounded-circle" onclick="carregarEventoEspecifico()" title="Atualizar Tabela">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between mb-4 align-items-center border-bottom pb-3">
                    <h5 class="m-0 text-muted" id="titulo-tabela"><i class="fas fa-arrow-left me-2"></i>Selecione um evento</h5>
                    
                    <div id="toolbar-acoes" style="display:none;">
                        <button class="btn btn-outline-primary me-2 shadow-sm" onclick="abrirModalLink()">
                            <i class="fas fa-link me-2"></i>Link Convite
                        </button>
                        <button class="btn btn-success me-2 shadow-sm" onclick="abrirModalImport()">
                            <i class="fas fa-file-excel me-2"></i>Importar
                        </button>
                        <button class="btn btn-primary shadow-sm" onclick="abrirModalAdd()">
                            <i class="fas fa-user-plus me-2"></i>Novo
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="tabela-dados">
                        <thead class="table-light text-secondary text-uppercase small"></thead>
                        <tbody></tbody>
                    </table>
                    <div id="msg-sem-dados" class="text-center p-5 text-muted">Aguardando sele√ß√£o...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="tela-novo" style="display:none;">
        <h3 class="fw-bold mb-4">Criar Novo Evento</h3>
        <div class="row">
            <div class="col-md-8 col-lg-7">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-4">
                        <form onsubmit="handleCriarEvento(event)">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Nome do Evento</label>
                                <input type="text" id="novo-nome" class="form-control form-control-lg" placeholder="Ex: Festa 2024" required>
                            </div>
                            <div class="mb-4">
                                <label class="form-label fw-bold">Origem dos Dados</label>
                                <div class="list-group mb-3">
                                    <label class="list-group-item list-group-item-action d-flex gap-2 bg-light border-primary">
                                        <input class="form-check-input flex-shrink-0" type="radio" name="novo-tipo" value="Importar" onchange="toggleAreaImportacao(true)">
                                        <span><strong><i class="fas fa-file-excel text-success me-1"></i> Importar do Excel</strong></span>
                                    </label>
                                    <label class="list-group-item list-group-item-action d-flex gap-2">
                                        <input class="form-check-input flex-shrink-0" type="radio" name="novo-tipo" value="Casamento" checked onchange="toggleAreaImportacao(false)">
                                        <span><strong>üíç Modelo Casamento</strong></span>
                                    </label>
                                    <label class="list-group-item list-group-item-action d-flex gap-2">
                                        <input class="form-check-input flex-shrink-0" type="radio" name="novo-tipo" value="Basico" onchange="toggleAreaImportacao(false)">
                                        <span><strong>üìù Modelo B√°sico</strong></span>
                                    </label>
                                </div>
                                <div id="area-importacao-criacao" class="p-3 bg-light border rounded" style="display:none;">
                                    <textarea id="texto-criacao-import" class="form-control mb-2" rows="6" placeholder="Cole do Excel..."></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg w-100 shadow-sm">Criar Evento</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalLink" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Link para Convidados</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body text-center">
                <p class="text-muted">Envie este link para os convidados:</p>
                <div class="input-group mb-3">
                    <input type="text" id="input-link-gerado" class="form-control text-center" readonly>
                    <button class="btn btn-outline-primary" onclick="copiarTextoLink()"><i class="fas fa-copy"></i></button>
                </div>
                <a id="btn-abrir-link" href="#" target="_blank" class="btn btn-light btn-sm"><i class="fas fa-external-link-alt"></i> Abrir para testar</a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAdd" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">Adicionar</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="form-dinamico"></div><div class="modal-footer"><button class="btn btn-primary" onclick="enviarConvidado()">Salvar</button></div></div></div>
</div>

<div class="modal fade" id="modalEditar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title text-dark">Editar Convidado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-linha-index">
                <div id="form-editar-dinamico"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning fw-bold" onclick="salvarEdicao()">Atualizar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalImport" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Importar</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" id="check-headers" checked><label class="form-check-label">1¬™ linha √© cabe√ßalho</label></div><textarea id="texto-importacao" class="form-control" rows="8"></textarea></div><div class="modal-footer"><button class="btn btn-success" onclick="processarImportacao()">Processar</button></div></div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ============================================================
    // ‚öôÔ∏è CONFIGURA√á√ÉO
    // ============================================================
    const API_URL = "https://script.google.com/macros/s/AKfycbznlB0UzqjzlkneSPFv1mi_0Jqqtv6DkZsbPctw28isyZvAwyXOBv2tHnQUl1SM1QQ/exec"; 
    
    // URL AUTOM√ÅTICA DO GITHUB
    const GITHUB_PAGES_URL = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);

    // ============================================================

    let colunasAtuais = [];
    let dadosEventoAtual = []; // Armazena os dados para facilitar a edi√ß√£o
    let eventoAtual = "";

    document.addEventListener('DOMContentLoaded', () => { carregarLista(); });

    async function chamarAPI(acao, dados = {}) {
        document.getElementById('loading').style.display = 'flex';
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ acao: acao, ...dados })
            });
            const json = await response.json();
            document.getElementById('loading').style.display = 'none';
            if (json.erro) { alert("Erro: " + json.erro); return null; }
            return json;
        } catch (e) {
            document.getElementById('loading').style.display = 'none';
            console.error(e);
            alert("Erro de conex√£o."); return null;
        }
    }

    async function carregarLista() {
        const dados = await chamarAPI('listarEventos');
        if (!dados) return;
        const select = document.getElementById('select-eventos');
        select.innerHTML = '<option value="" disabled selected>Selecione um evento...</option>';
        dados.forEach(ev => select.innerHTML += `<option value="${ev.nome}">${ev.nome}</option>`);
    }

    async function carregarEventoEspecifico() {
        const nome = document.getElementById('select-eventos').value;
        if (!nome) return;
        eventoAtual = nome;
        
        const dados = await chamarAPI('obterDadosEvento', { nomeEvento: nome });
        if (!dados) return;

        colunasAtuais = dados.headers;
        dadosEventoAtual = dados.rows; // Guarda para edi√ß√£o

        document.getElementById('titulo-tabela').innerText = nome;
        document.getElementById('msg-sem-dados').style.display = 'none';
        document.getElementById('toolbar-acoes').style.display = 'block';
        
        renderizarTabela(dados.headers, dados.rows);
    }

    function renderizarTabela(headers, rows) {
        const thead = document.querySelector('#tabela-dados thead');
        const tbody = document.querySelector('#tabela-dados tbody');
        
        // Cabe√ßalho (adiciona coluna A√ß√µes)
        let headerHTML = "<tr>";
        headers.forEach(h => headerHTML += `<th>${h}</th>`);
        headerHTML += `<th class="text-center" style="width: 50px;">A√ß√µes</th>`;
        headerHTML += "</tr>";
        thead.innerHTML = headerHTML;
        
        // Corpo
        if (rows.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${headers.length + 1}" class="text-center p-4">Vazio</td></tr>`;
        } else {
            let bodyHTML = "";
            rows.forEach((row, index) => {
                bodyHTML += "<tr>";
                row.forEach(cell => bodyHTML += `<td>${cell}</td>`);
                // Bot√£o de Editar
                bodyHTML += `
                    <td class="text-center">
                        <button class="btn btn-light btn-action text-primary shadow-sm" onclick="abrirModalEditar(${index})" title="Editar">
                            <i class="fas fa-pen"></i>
                        </button>
                    </td>`;
                bodyHTML += "</tr>";
            });
            tbody.innerHTML = bodyHTML;
        }
    }

    // --- FUN√á√ïES DE EDI√á√ÉO (NOVO) ---
    
    function abrirModalEditar(rowIndex) {
        // Pega os dados da linha clicada
        const dadosRow = dadosEventoAtual[rowIndex];
        document.getElementById('edit-linha-index').value = rowIndex; // Guarda o √≠ndice para salvar depois

        const form = document.getElementById('form-editar-dinamico');
        form.innerHTML = "";

        colunasAtuais.forEach((col, colIndex) => {
            const valorAtual = dadosRow[colIndex];
            let inputHTML = "";

            if (col === 'Status') {
                inputHTML = `
                    <select class="form-select input-editar">
                        <option value="Pendente" ${valorAtual === 'Pendente' ? 'selected' : ''}>Pendente</option>
                        <option value="Confirmado" ${valorAtual === 'Confirmado' ? 'selected' : ''}>Confirmado</option>
                        <option value="N√£o vai" ${valorAtual === 'N√£o vai' ? 'selected' : ''}>N√£o vai</option>
                    </select>`;
            } else {
                inputHTML = `<input type="text" class="form-control input-editar" value="${valorAtual}">`;
            }

            form.innerHTML += `
                <div class="mb-3">
                    <label class="fw-bold small text-muted">${col}</label>
                    ${inputHTML}
                </div>`;
        });

        new bootstrap.Modal(document.getElementById('modalEditar')).show();
    }

    async function salvarEdicao() {
        const rowIndex = parseInt(document.getElementById('edit-linha-index').value);
        const inputs = document.querySelectorAll('.input-editar');
        const novosDados = Array.from(inputs).map(i => i.value);

        // Fecha modal
        bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide();

        // Envia para o backend (Lembrando que linha no Sheet come√ßa em 1, e temos cabe√ßalho, ent√£o index + 2)
        const res = await chamarAPI('atualizarConvidado', { 
            nomeEvento: eventoAtual, 
            linha: rowIndex + 2, 
            novosDados: novosDados 
        });

        if (res && res.sucesso) {
            // Recarrega a tabela para mostrar mudan√ßas
            carregarEventoEspecifico();
        }
    }

    // --- FUN√á√ïES ANTERIORES ---

    function abrirModalLink() {
        if(!eventoAtual) return;
        const link = `${GITHUB_PAGES_URL}index.html?evento=${encodeURIComponent(eventoAtual)}`;
        document.getElementById('input-link-gerado').value = link;
        document.getElementById('btn-abrir-link').href = link;
        new bootstrap.Modal(document.getElementById('modalLink')).show();
    }

    function copiarTextoLink() {
        const input = document.getElementById('input-link-gerado');
        input.select();
        navigator.clipboard.writeText(input.value);
        alert("Link copiado!");
    }

    function toggleAreaImportacao(mostrar) { document.getElementById('area-importacao-criacao').style.display = mostrar ? 'block' : 'none'; }

    async function handleCriarEvento(e) {
        e.preventDefault();
        const nome = document.getElementById('novo-nome').value;
        const tipo = document.querySelector('input[name="novo-tipo"]:checked').value;
        let dadosRaw = "";
        if (tipo === 'Importar') dadosRaw = document.getElementById('texto-criacao-import').value;
        
        const res = await chamarAPI('criarNovoEvento', { nome: nome, template: tipo, dadosImportados: dadosRaw });
        if (res && res.sucesso) { alert("Evento criado!"); mostrarTela('dashboard'); carregarLista(); }
    }

    function abrirModalImport() { document.getElementById('texto-importacao').value = ""; new bootstrap.Modal(document.getElementById('modalImport')).show(); }
    async function processarImportacao() {
        const texto = document.getElementById('texto-importacao').value;
        const temCabecalho = document.getElementById('check-headers').checked;
        const linhas = texto.trim().split('\n');
        const matriz = linhas.map(l => l.split('\t')); 
        bootstrap.Modal.getInstance(document.getElementById('modalImport')).hide();
        const res = await chamarAPI('importarListaConvidados', { nomeEvento: eventoAtual, matrizDados: matriz, temCabecalho: temCabecalho });
        if (res && res.sucesso) carregarEventoEspecifico();
    }

    function abrirModalAdd() {
        const form = document.getElementById('form-dinamico');
        form.innerHTML = "";
        colunasAtuais.forEach(col => {
            let inputHTML = col === 'Status' ? `<select class="form-select input-dinamico"><option>Pendente</option><option>Confirmado</option><option>N√£o vai</option></select>` : `<input type="text" class="form-control input-dinamico">`;
            form.innerHTML += `<div class="mb-3"><label class="fw-bold small">${col}</label>${inputHTML}</div>`;
        });
        new bootstrap.Modal(document.getElementById('modalAdd')).show();
    }
    async function enviarConvidado() {
        const vals = Array.from(document.querySelectorAll('.input-dinamico')).map(i => i.value);
        bootstrap.Modal.getInstance(document.getElementById('modalAdd')).hide();
        const res = await chamarAPI('adicionarConvidado', { nomeEvento: eventoAtual, arrayDados: vals });
        if (res && res.sucesso) carregarEventoEspecifico();
    }

    function mostrarTela(tela) {
        document.getElementById('tela-dashboard').style.display = tela === 'dashboard' ? 'block' : 'none';
        document.getElementById('tela-novo').style.display = tela === 'novo' ? 'block' : 'none';
    }
</script>
</body>
</html>
