<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Eventos - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .sidebar { height: 100vh; background: white; border-right: 1px solid #dee2e6; position: fixed; width: 250px; z-index: 100;}
        .content { margin-left: 250px; padding: 20px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; }
        textarea.form-control { font-family: monospace; font-size: 0.85rem; background-color: #fafafa; }
        
        .card-stat { border: none; border-radius: 12px; transition: transform 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card-stat:hover { transform: translateY(-3px); }
        .stat-icon { font-size: 2rem; opacity: 0.2; position: absolute; right: 15px; top: 15px; }
        .btn-action { width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; }
        .btn-action:hover { transform: scale(1.1); }

        .nav-tabs .nav-link { color: #495057; font-weight: 500; border: none; border-bottom: 3px solid transparent; background: transparent; }
        .nav-tabs .nav-link:hover { color: #0d6efd; border-color: transparent; }
        .nav-tabs .nav-link.active { color: #0d6efd; font-weight: bold; border-bottom: 3px solid #0d6efd; background: transparent; }
        .nav-tabs { border-bottom: 2px solid #e9ecef; margin-bottom: 20px; }
        
        #qrcode { display: flex; justify-content: center; margin: 20px 0; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary" role="status"></div>
    <span class="mt-3 fw-bold text-secondary">Carregando...</span>
</div>

<div class="sidebar p-4 d-flex flex-column shadow-sm">
    <h5 class="text-primary mb-4 fw-bold"><i class="fas fa-calendar-check me-2"></i>Gestor RSVP</h5>
    <div class="d-grid gap-2">
        <button class="btn btn-light text-start active fw-semibold shadow-sm" onclick="mostrarTela('dashboard')">
            <i class="fas fa-chart-pie me-2 text-primary"></i>Dashboard
        </button>
        <button class="btn btn-light text-start fw-semibold shadow-sm" onclick="mostrarTela('novo')">
            <i class="fas fa-plus me-2 text-success"></i>Novo Evento
        </button>
    </div>
    <div class="mt-auto text-muted small pt-3 border-top">v11.0 - Relat√≥rios PDF/TXT</div>
</div>

<div class="content">
    
    <div id="tela-dashboard">
        <h3 class="fw-bold text-dark mb-4">Painel de Controle</h3>

        <div class="d-flex align-items-center">
            <ul class="nav nav-tabs flex-grow-1" id="tab-lista-eventos">
                <li class="nav-item"><a class="nav-link disabled">Carregando eventos...</a></li>
            </ul>
            <button class="btn btn-light text-secondary rounded-circle ms-2 mb-3 shadow-sm" onclick="carregarEventoEspecifico(eventoAtual)" title="Atualizar">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>

        <div id="area-stats" style="display:none;">
            <div class="row mb-4 g-3">
                <div class="col-md-3"><div class="card card-stat bg-white text-dark"><div class="card-body position-relative"><i class="fas fa-users stat-icon text-primary"></i><h6 class="text-uppercase text-muted small fw-bold">Total</h6><h2 class="fw-bold mb-0" id="stat-total">0</h2></div></div></div>
                <div class="col-md-3"><div class="card card-stat bg-success text-white"><div class="card-body position-relative"><i class="fas fa-check-circle stat-icon text-white"></i><h6 class="text-uppercase text-white-50 small fw-bold">Confirmados</h6><h2 class="fw-bold mb-0" id="stat-confirmados">0</h2></div></div></div>
                <div class="col-md-3"><div class="card card-stat bg-warning text-dark"><div class="card-body position-relative"><i class="fas fa-clock stat-icon text-dark"></i><h6 class="text-uppercase text-muted small fw-bold">Pendentes</h6><h2 class="fw-bold mb-0" id="stat-pendentes">0</h2></div></div></div>
                <div class="col-md-3"><div class="card card-stat bg-danger text-white"><div class="card-body position-relative"><i class="fas fa-times-circle stat-icon text-white"></i><h6 class="text-uppercase text-white-50 small fw-bold">Recusados</h6><h2 class="fw-bold mb-0" id="stat-recusados">0</h2></div></div></div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6 offset-md-3">
                    <div class="card border-0 shadow-sm" style="border-radius: 15px;">
                        <div class="card-body">
                            <h6 class="text-center text-muted mb-3">Vis√£o Geral</h6>
                            <div style="height: 250px; position: relative;">
                                <canvas id="meuGrafico"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between mb-4 align-items-center border-bottom pb-3 flex-wrap gap-2">
                    <h5 class="m-0 text-muted" id="titulo-tabela">Detalhes do Evento</h5>
                    
                    <div id="toolbar-acoes" style="display:none;">
                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-outline-secondary shadow-sm" onclick="baixarTXT()" title="Baixar TXT">
                                <i class="fas fa-file-alt"></i> TXT
                            </button>
                            <button type="button" class="btn btn-outline-danger shadow-sm" onclick="baixarPDF()" title="Baixar PDF">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>

                        <button class="btn btn-outline-primary me-2 shadow-sm" onclick="abrirModalLink()">
                            <i class="fas fa-qrcode me-2"></i>Link & QR
                        </button>
                        
                        <div class="btn-group shadow-sm">
                            <button class="btn btn-success" onclick="abrirModalImport()">
                                <i class="fas fa-file-excel me-1"></i>Importar
                            </button>
                            <button class="btn btn-primary" onclick="abrirModalAdd()">
                                <i class="fas fa-user-plus me-1"></i>Novo
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="tabela-dados">
                        <thead class="table-light text-secondary text-uppercase small"></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="tela-novo" style="display:none;">
        <h3 class="fw-bold mb-4">Criar Novo Evento</h3>
        <div class="row">
            <div class="col-md-8 col-lg-7">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-4">
                        <form onsubmit="handleCriarEvento(event)">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Nome do Evento</label>
                                <input type="text" id="novo-nome" class="form-control form-control-lg" placeholder="Ex: Festa 2024" required>
                            </div>
                            <div class="mb-4">
                                <label class="form-label fw-bold">Origem dos Dados</label>
                                <div class="list-group mb-3">
                                    <label class="list-group-item list-group-item-action d-flex gap-2 bg-light border-primary">
                                        <input class="form-check-input flex-shrink-0" type="radio" name="novo-tipo" value="Importar" onchange="toggleAreaImportacao(true)">
                                        <span><strong><i class="fas fa-file-excel text-success me-1"></i> Importar do Excel</strong></span>
                                    </label>
                                    <label class="list-group-item list-group-item-action d-flex gap-2">
                                        <input class="form-check-input flex-shrink-0" type="radio" name="novo-tipo" value="Casamento" checked onchange="toggleAreaImportacao(false)">
                                        <span><strong>üíç Modelo Casamento</strong></span>
                                    </label>
                                    <label class="list-group-item list-group-item-action d-flex gap-2">
                                        <input class="form-check-input flex-shrink-0" type="radio" name="novo-tipo" value="Basico" onchange="toggleAreaImportacao(false)">
                                        <span><strong>üìù Modelo B√°sico</strong></span>
                                    </label>
                                </div>
                                <div id="area-importacao-criacao" class="p-3 bg-light border rounded" style="display:none;">
                                    <textarea id="texto-criacao-import" class="form-control mb-2" rows="6" placeholder="Cole do Excel..."></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg w-100 shadow-sm">Criar Evento</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalLink" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Link & QR Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><div id="qrcode"></div><p class="small text-muted mb-4">Escaneie para testar</p><div class="input-group mb-3"><input type="text" id="input-link-gerado" class="form-control text-center" readonly><button class="btn btn-outline-primary" onclick="copiarTextoLink()"><i class="fas fa-copy"></i></button></div><a id="btn-abrir-link" href="#" target="_blank" class="btn btn-light btn-sm"><i class="fas fa-external-link-alt"></i> Abrir link</a></div></div></div></div>
<div class="modal fade" id="modalEditar" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title text-dark">Editar Convidado</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="edit-linha-index"><div id="form-editar-dinamico"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-warning fw-bold" onclick="salvarEdicao()">Salvar Altera√ß√µes</button></div></div></div></div>
<div class="modal fade" id="modalAdd" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">Adicionar</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="form-dinamico"></div><div class="modal-footer"><button class="btn btn-primary" onclick="enviarConvidado()">Salvar</button></div></div></div></div>
<div class="modal fade" id="modalImport" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Importar</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" id="check-headers" checked><label class="form-check-label">1¬™ linha √© cabe√ßalho</label></div><textarea id="texto-importacao" class="form-control" rows="8"></textarea></div><div class="modal-footer"><button class="btn btn-success" onclick="processarImportacao()">Processar</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ============================================================
    // ‚öôÔ∏è CONFIGURA√á√ÉO
    // ============================================================
    const API_URL = "https://script.google.com/macros/s/AKfycbznlB0UzqjzlkneSPFv1mi_0Jqqtv6DkZsbPctw28isyZvAwyXOBv2tHnQUl1SM1QQ/exec"; 
    const GITHUB_PAGES_URL = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);

    // ============================================================

    let colunasAtuais = [];
    let dadosEventoAtual = []; 
    let eventoAtual = "";
    let graficoInstance = null;

    document.addEventListener('DOMContentLoaded', () => { carregarLista(); });

    async function chamarAPI(acao, dados = {}) {
        document.getElementById('loading').style.display = 'flex';
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ acao: acao, ...dados })
            });
            const json = await response.json();
            document.getElementById('loading').style.display = 'none';
            if (json.erro) { alert("Erro: " + json.erro); return null; }
            return json;
        } catch (e) {
            document.getElementById('loading').style.display = 'none';
            console.error(e);
            alert("Erro de conex√£o."); return null;
        }
    }

    async function carregarLista() {
        const dados = await chamarAPI('listarEventos');
        if (!dados) return;
        const tabContainer = document.getElementById('tab-lista-eventos');
        tabContainer.innerHTML = ''; 
        if (dados.length === 0) { tabContainer.innerHTML = '<li class="nav-item"><a class="nav-link disabled">Nenhum evento criado</a></li>'; return; }
        dados.forEach((ev, index) => {
            const li = document.createElement('li'); li.className = 'nav-item';
            const btn = document.createElement('button'); btn.className = index === 0 ? 'nav-link active' : 'nav-link'; btn.innerText = ev.nome;
            btn.onclick = () => { document.querySelectorAll('#tab-lista-eventos .nav-link').forEach(el => el.classList.remove('active')); btn.classList.add('active'); carregarEventoEspecifico(ev.nome); };
            li.appendChild(btn); tabContainer.appendChild(li);
        });
        if (dados.length > 0) carregarEventoEspecifico(dados[0].nome);
    }

    async function carregarEventoEspecifico(nome) {
        if (!nome) return;
        eventoAtual = nome;
        const dados = await chamarAPI('obterDadosEvento', { nomeEvento: nome });
        if (!dados) return;
        colunasAtuais = dados.headers;
        dadosEventoAtual = dados.rows;
        atualizarDashboard(dados.headers, dados.rows);
        renderizarTabela(dados.headers, dados.rows);
        document.getElementById('toolbar-acoes').style.display = 'block';
    }

    function atualizarDashboard(headers, rows) {
        document.getElementById('area-stats').style.display = 'block';
        const indexStatus = headers.indexOf('Status');
        let confirmados = 0, pendentes = 0, recusados = 0, total = rows.length;
        if (indexStatus > -1) {
            rows.forEach(row => {
                const status = row[indexStatus] || "Pendente";
                if (status === 'Confirmado') confirmados++; else if (status === 'N√£o vai') recusados++; else pendentes++;
            });
        } else { pendentes = total; }
        document.getElementById('stat-total').innerText = total; document.getElementById('stat-confirmados').innerText = confirmados;
        document.getElementById('stat-pendentes').innerText = pendentes; document.getElementById('stat-recusados').innerText = recusados;
        const ctx = document.getElementById('meuGrafico').getContext('2d');
        if (graficoInstance) graficoInstance.destroy();
        graficoInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['Confirmados', 'Pendentes', 'Recusados'], datasets: [{ data: [confirmados, pendentes, recusados], backgroundColor: ['#198754', '#ffc107', '#dc3545'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
    }

    function renderizarTabela(headers, rows) {
        const thead = document.querySelector('#tabela-dados thead');
        const tbody = document.querySelector('#tabela-dados tbody');
        let headerHTML = "<tr>"; headers.forEach(h => headerHTML += `<th>${h}</th>`); headerHTML += `<th class="text-center" style="width: 100px;">A√ß√µes</th></tr>`; thead.innerHTML = headerHTML;
        if (rows.length === 0) { tbody.innerHTML = `<tr><td colspan="${headers.length + 1}" class="text-center p-4">Vazio</td></tr>`; } else {
            let bodyHTML = "";
            rows.forEach((row, index) => {
                bodyHTML += "<tr>"; row.forEach(cell => bodyHTML += `<td>${cell}</td>`);
                bodyHTML += `<td class="text-center"><button class="btn btn-light btn-action text-primary shadow-sm me-1" onclick="abrirModalEditar(${index})" title="Editar"><i class="fas fa-pen"></i></button><button class="btn btn-light btn-action text-danger shadow-sm" onclick="confirmarExclusao(${index})" title="Excluir"><i class="fas fa-trash"></i></button></td></tr>`;
            });
            tbody.innerHTML = bodyHTML;
        }
    }

    // --- RELAT√ìRIOS (NOVO) ---
    
    function baixarTXT() {
        if (!eventoAtual || dadosEventoAtual.length === 0) return alert("Nenhum dado para exportar.");
        
        let conteudo = `RELAT√ìRIO: ${eventoAtual}\n`;
        conteudo += `Data: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}\n`;
        conteudo += `--------------------------------------------------\n\n`;

        dadosEventoAtual.forEach(row => {
            colunasAtuais.forEach((col, i) => {
                conteudo += `${col}: ${row[i]} | `;
            });
            conteudo += `\n`;
        });

        conteudo += `\n--------------------------------------------------\n`;
        conteudo += `Total: ${dadosEventoAtual.length} convidados.`;

        const blob = new Blob([conteudo], { type: "text/plain;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Relatorio_${eventoAtual}.txt`;
        link.click();
    }

    function baixarPDF() {
        if (!eventoAtual || dadosEventoAtual.length === 0) return alert("Nenhum dado para exportar.");
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // T√≠tulo
        doc.setFontSize(18);
        doc.text(eventoAtual, 14, 22);
        
        // Data
        doc.setFontSize(11);
        doc.setTextColor(100);
        doc.text(`Gerado em: ${new Date().toLocaleDateString()}`, 14, 30);

        // Tabela
        doc.autoTable({
            head: [colunasAtuais],
            body: dadosEventoAtual,
            startY: 40,
            theme: 'grid',
            headStyles: { fillColor: [30, 58, 138] }, // Cor do sistema (#1e3a8a)
        });

        doc.save(`Relatorio_${eventoAtual}.pdf`);
    }

    // --- OUTRAS FUN√á√ïES ---
    async function confirmarExclusao(index) { if(!confirm("Tem certeza que deseja EXCLUIR este convidado?")) return; const res = await chamarAPI('excluirConvidado', { nomeEvento: eventoAtual, linha: index + 2 }); if(res && res.sucesso) carregarEventoEspecifico(eventoAtual); }
    function abrirModalEditar(rowIndex) { const dadosRow = dadosEventoAtual[rowIndex]; document.getElementById('edit-linha-index').value = rowIndex; const form = document.getElementById('form-editar-dinamico'); form.innerHTML = ""; colunasAtuais.forEach((col, colIndex) => { const valorAtual = dadosRow[colIndex]; let inputHTML = ""; if (col === 'Status') { inputHTML = `<select class="form-select input-editar"><option value="Pendente" ${valorAtual === 'Pendente' ? 'selected' : ''}>Pendente</option><option value="Confirmado" ${valorAtual === 'Confirmado' ? 'selected' : ''}>Confirmado</option><option value="N√£o vai" ${valorAtual === 'N√£o vai' ? 'selected' : ''}>N√£o vai</option></select>`; } else { inputHTML = `<input type="text" class="form-control input-editar" value="${valorAtual}">`; } form.innerHTML += `<div class="mb-3"><label class="fw-bold small text-muted">${col}</label>${inputHTML}</div>`; }); new bootstrap.Modal(document.getElementById('modalEditar')).show(); }
    async function salvarEdicao() { const rowIndex = parseInt(document.getElementById('edit-linha-index').value); const inputs = document.querySelectorAll('.input-editar'); const novosDados = Array.from(inputs).map(i => i.value); bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide(); const res = await chamarAPI('atualizarConvidado', { nomeEvento: eventoAtual, linha: rowIndex + 2, novosDados: novosDados }); if (res && res.sucesso) carregarEventoEspecifico(eventoAtual); }
    function abrirModalLink() { if(!eventoAtual) return; const link = `${GITHUB_PAGES_URL}index.html?evento=${encodeURIComponent(eventoAtual)}`; document.getElementById('input-link-gerado').value = link; document.getElementById('btn-abrir-link').href = link; const qrContainer = document.getElementById('qrcode'); qrContainer.innerHTML = ""; new QRCode(qrContainer, { text: link, width: 128, height: 128, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H }); new bootstrap.Modal(document.getElementById('modalLink')).show(); }
    function copiarTextoLink() { const i = document.getElementById('input-link-gerado'); i.select(); navigator.clipboard.writeText(i.value); alert("Link copiado!"); }
    function toggleAreaImportacao(mostrar) { document.getElementById('area-importacao-criacao').style.display = mostrar ? 'block' : 'none'; }
    async function handleCriarEvento(e) { e.preventDefault(); const n = document.getElementById('novo-nome').value; const t = document.querySelector('input[name="novo-tipo"]:checked').value; let d = ""; if (t === 'Importar') d = document.getElementById('texto-criacao-import').value; const res = await chamarAPI('criarNovoEvento', { nome: n, template: t, dadosImportados: d }); if (res && res.sucesso) { alert("Evento criado!"); mostrarTela('dashboard'); carregarLista(); } }
    function abrirModalImport() { document.getElementById('texto-importacao').value = ""; new bootstrap.Modal(document.getElementById('modalImport')).show(); }
    async function processarImportacao() { const t = document.getElementById('texto-importacao').value; const h = document.getElementById('check-headers').checked; const l = t.trim().split('\n'); const m = l.map(l => l.split('\t')); bootstrap.Modal.getInstance(document.getElementById('modalImport')).hide(); const res = await chamarAPI('importarListaConvidados', { nomeEvento: eventoAtual, matrizDados: m, temCabecalho: h }); if (res && res.sucesso) carregarEventoEspecifico(eventoAtual); }
    function abrirModalAdd() { const f = document.getElementById('form-dinamico'); f.innerHTML = ""; colunasAtuais.forEach(c => { let i = c === 'Status' ? `<select class="form-select input-dinamico"><option>Pendente</option><option>Confirmado</option><option>N√£o vai</option></select>` : `<input type="text" class="form-control input-dinamico">`; f.innerHTML += `<div class="mb-3"><label class="fw-bold small">${c}</label>${i}</div>`; }); new bootstrap.Modal(document.getElementById('modalAdd')).show(); }
    async function enviarConvidado() { const v = Array.from(document.querySelectorAll('.input-dinamico')).map(i => i.value); bootstrap.Modal.getInstance(document.getElementById('modalAdd')).hide(); const res = await chamarAPI('adicionarConvidado', { nomeEvento: eventoAtual, arrayDados: v }); if (res && res.sucesso) carregarEventoEspecifico(eventoAtual); }
    function mostrarTela(t) { document.getElementById('tela-dashboard').style.display = t === 'dashboard' ? 'block' : 'none'; document.getElementById('tela-novo').style.display = t === 'novo' ? 'block' : 'none'; }
</script>
</body>
</html>
