<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Eventos - Master</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        :root { --primary-blue: #1e3a8a; --primary-light: #3b82f6; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .sidebar { height: 100vh; background: white; border-right: 1px solid #dee2e6; position: fixed; width: 250px; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .content { margin-left: 250px; padding: 30px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(4px); }
        .card-stat { border: none; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card-stat:hover { transform: translateY(-4px); }
        .stat-icon { font-size: 2.5rem; opacity: 0.15; position: absolute; right: 15px; top: 15px; }
        .nav-tabs .nav-link { color: #495057; border: none; border-bottom: 3px solid transparent; padding: 12px 20px; transition: all 0.2s; }
        .nav-tabs .nav-link.active { color: var(--primary-light); font-weight: bold; border-bottom: 3px solid var(--primary-light); }
        .toolbar-massa { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4px solid var(--primary-blue); border-radius: 12px; padding: 16px 20px; margin-bottom: 20px; display: none; }
        .check-convidado { cursor: pointer; width: 18px; height: 18px; }
        .ocultar-pdf { display: table-cell; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast-notification { background: white; padding: 16px 20px; border-radius: 12px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 12px; margin-bottom: 10px; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .toast-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
        .toast-icon.success { background: var(--success); }
        .toast-icon.error { background: var(--danger); }
        .toast-icon.warning { background: var(--warning); }
        .list-group-item-action { cursor: pointer; }
    </style>
</head>
<body>

<div id="toast-container"></div>
<div id="loading" class="loading-overlay"><div class="spinner-border text-primary" role="status"></div><span class="mt-3 fw-bold text-secondary">Processando...</span></div>

<div class="sidebar p-4 d-flex flex-column">
    <h5 class="text-primary mb-4 fw-bold"><i class="fas fa-calendar-check me-2"></i>Gestor RSVP</h5>
    <div class="d-grid gap-2">
        <button class="btn btn-light active fw-semibold text-start" onclick="mostrarTela('dashboard')"><i class="fas fa-chart-pie me-2 text-primary"></i>Dashboard</button>
        <button class="btn btn-light fw-semibold text-start" onclick="mostrarTela('novo')"><i class="fas fa-plus me-2 text-success"></i>Novo Evento</button>
    </div>
    <div class="mt-auto text-muted small pt-3 border-top">v14.3 - Fix Undefined</div>
</div>

<div class="content">
    <div id="tela-dashboard">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold text-dark m-0">Painel de Controle</h3>
            <div>
                <button class="btn btn-light text-secondary me-2" onclick="abrirModalConfig()" title="Configurações"><i class="fas fa-cog"></i></button>
                <button class="btn btn-light text-secondary" onclick="carregarEventoEspecifico(eventoAtual)" title="Atualizar"><i class="fas fa-sync-alt"></i></button>
            </div>
        </div>

        <ul class="nav nav-tabs mb-4 flex-grow-1" id="tab-lista-eventos"><li class="nav-item"><a class="nav-link disabled">Carregando...</a></li></ul>

        <div id="area-stats" style="display:none;">
            <div class="row mb-4 g-3">
                <div class="col-md-3"><div class="card card-stat bg-white text-dark"><div class="card-body position-relative"><i class="fas fa-users stat-icon text-primary"></i><h6 class="text-uppercase text-muted small fw-bold">Total</h6><h2 class="fw-bold mb-0" id="stat-total">0</h2></div></div></div>
                <div class="col-md-3"><div class="card card-stat bg-success text-white"><div class="card-body position-relative"><i class="fas fa-check-circle stat-icon text-white"></i><h6 class="text-uppercase text-white-50 small fw-bold">Confirmados</h6><h2 class="fw-bold mb-0" id="stat-confirmados">0</h2></div></div></div>
                <div class="col-md-3"><div class="card card-stat bg-warning text-dark"><div class="card-body position-relative"><i class="fas fa-clock stat-icon text-dark"></i><h6 class="text-uppercase text-muted small fw-bold">Pendentes</h6><h2 class="fw-bold mb-0" id="stat-pendentes">0</h2></div></div></div>
                <div class="col-md-3"><div class="card card-stat bg-danger text-white"><div class="card-body position-relative"><i class="fas fa-times-circle stat-icon text-white"></i><h6 class="text-uppercase text-white-50 small fw-bold">Recusados</h6><h2 class="fw-bold mb-0" id="stat-recusados">0</h2></div></div></div>
            </div>
            <div class="row mb-4 justify-content-center">
                <div class="col-md-6"><div class="card border-0 shadow-sm rounded-4"><div class="card-body text-center"><h6 class="text-muted mb-3">Visão Geral</h6><div style="height: 200px; position: relative;"><canvas id="meuGrafico"></canvas></div></div></div></div>
            </div>
        </div>

        <div id="toolbar-massa" class="toolbar-massa">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                <strong><i class="fas fa-check-square me-2"></i><span id="count-selecionados">0</span> selecionados</strong>
                <div class="btn-group">
                    <button class="btn btn-sm btn-success" onclick="atualizarEmMassa('Confirmado')">Confirmar</button>
                    <button class="btn btn-sm btn-warning" onclick="atualizarEmMassa('Pendente')">Pendente</button>
                    <button class="btn btn-sm btn-danger" onclick="atualizarEmMassa('Não vai')">Recusar</button>
                </div>
                <button id="btn-massa-email" class="btn btn-sm btn-primary" style="display:none;" onclick="abrirModalEmail()"><i class="fas fa-envelope me-1"></i>Enviar Convite</button>
                <button class="btn btn-sm btn-light" onclick="limparSelecao()">Limpar</button>
            </div>
        </div>

        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between mb-4 align-items-center flex-wrap gap-3">
                    <div class="input-group" style="max-width: 300px;">
                        <span class="input-group-text bg-white border-end-0"><i class="fas fa-search"></i></span>
                        <input type="text" id="busca-rapida" class="form-control border-start-0" placeholder="Buscar..." onkeyup="filtrarTabela()">
                    </div>
                    <div id="toolbar-acoes" style="display:none;">
                        <div class="btn-group me-2">
                            <button class="btn btn-outline-secondary btn-sm" onclick="gerarPDF()">PDF</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="gerarExcel()">XLS</button>
                        </div>
                        <button class="btn btn-outline-primary btn-sm me-2" onclick="abrirModalLink()"><i class="fas fa-qrcode me-1"></i>Link</button>
                        <button class="btn btn-success btn-sm me-2" onclick="abrirModalImport()"><i class="fas fa-file-excel me-1"></i>Importar</button>
                        <button class="btn btn-primary btn-sm" onclick="abrirModalAdd()"><i class="fas fa-plus me-1"></i>Novo</button>
                    </div>
                </div>
                <div id="container-tabela-exportar" class="table-responsive">
                    <table class="table table-hover align-middle" id="tabela-dados"><thead></thead><tbody></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <div id="tela-novo" style="display:none;">
        <h3 class="mb-4">Criar Novo Evento</h3>
        <div class="card shadow-sm border-0 rounded-4 p-4" style="max-width: 600px;">
            <form onsubmit="handleCriarEvento(event)">
                <div class="mb-3"><label class="form-label fw-bold">Nome</label><input type="text" id="novo-nome" class="form-control" required></div>
                <div class="mb-4"><label class="form-label fw-bold">Modelo</label><select id="novo-tipo" class="form-select mb-2" onchange="toggleAreaImportacao(this.value === 'Importar')"><option value="Casamento">Casamento</option><option value="Corporativo">Corporativo</option><option value="Basico">Básico</option><option value="Importar">Importar do Excel</option></select><textarea id="texto-criacao-import" class="form-control" rows="5" style="display:none;" placeholder="Cole aqui..."></textarea></div>
                <button class="btn btn-primary w-100">Criar</button>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalConfig" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-light"><h5 class="modal-title">Configurações</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><h6 class="fw-bold">Renomear</h6><div class="input-group mb-4"><input type="text" id="input-renomear" class="form-control"><button class="btn btn-outline-primary" onclick="salvarRenomeacao()">Salvar</button></div><h6 class="fw-bold">Colunas</h6><div class="input-group mb-2"><input type="text" id="input-nova-coluna" class="form-control" placeholder="Nova Coluna"><button class="btn btn-outline-success" onclick="addColuna()">Add</button></div><ul class="list-group" id="lista-colunas-config"></ul></div></div></div></div>
<div class="modal fade" id="modalEmail" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title"><i class="fas fa-paper-plane me-2"></i>Enviar Convites</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="text-muted small">Serão enviados e-mails para os contatos selecionados.</p><div class="mb-3"><label class="fw-bold">Assunto</label><input type="text" id="email-assunto" class="form-control" value="Convite para {Nome}"></div><div class="mb-3"><label class="fw-bold">Mensagem</label><textarea id="email-mensagem" class="form-control" rows="5">Olá {Nome},\n\nConfirme sua presença: {Link}</textarea></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="processarEnvioEmails()">Enviar Agora</button></div></div></div></div>
<div class="modal fade" id="modalLink" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Link</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><div id="qrcode"></div><input type="text" id="input-link-gerado" class="form-control mt-3 mb-2" readonly><button class="btn btn-primary btn-sm" onclick="copiarTextoLink()">Copiar</button> <a id="btn-abrir-link" href="#" target="_blank" class="btn btn-light btn-sm">Abrir</a></div></div></div></div>
<div class="modal fade" id="modalEditar" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title">Editar</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="edit-linha-index"><div id="form-editar-dinamico"></div></div><div class="modal-footer"><button class="btn btn-warning" onclick="salvarEdicao()">Salvar</button></div></div></div></div>
<div class="modal fade" id="modalAdd" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">Adicionar</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="form-dinamico"></div><div class="modal-footer"><button class="btn btn-primary" onclick="enviarConvidado()">Salvar</button></div></div></div></div>
<div class="modal fade" id="modalImport" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Importar</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" id="check-headers" checked><label class="form-check-label">1ª linha é cabeçalho</label></div><textarea id="texto-importacao" class="form-control" rows="8"></textarea></div><div class="modal-footer"><button class="btn btn-success" onclick="processarImportacao()">Processar</button></div></div></div></div>
<div class="modal fade" id="modalConfirmacao" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg"><div class="modal-body text-center p-5"><h4 class="fw-bold mb-3" id="confirm-titulo">Confirmar?</h4><p class="text-muted" id="confirm-mensagem">Esta ação não pode ser desfeita.</p><div class="d-flex gap-3 mt-4"><button class="btn btn-light flex-fill" data-bs-dismiss="modal">Cancelar</button><button class="btn btn-danger flex-fill fw-bold" id="confirm-btn-ok">Confirmar</button></div></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = "COLE_AQUI_A_SUA_URL_DO_GOOGLE_SCRIPT_QUE_TERMINA_EM_EXEC"; 
    const GITHUB_PAGES_URL = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);

    let colunasAtuais = [], dadosEventoAtual = [], eventoAtual = "", graficoInstance = null, convidadosSelecionados = [];

    document.addEventListener('DOMContentLoaded', () => { carregarLista(); });

    function mostrarToast(msg, tipo='success') {
        const div = document.getElementById('toast-container');
        const el = document.createElement('div'); el.className = 'toast-notification';
        el.innerHTML = `<div class="toast-icon ${tipo}"></div> ${msg}`; div.appendChild(el); setTimeout(() => el.remove(), 3000);
    }

    function confirmarAcao(titulo, mensagem) {
        return new Promise((resolve) => {
            document.getElementById('confirm-titulo').innerText = titulo;
            document.getElementById('confirm-mensagem').innerText = mensagem;
            const modal = new bootstrap.Modal(document.getElementById('modalConfirmacao'));
            document.getElementById('confirm-btn-ok').onclick = () => { modal.hide(); resolve(true); };
            document.getElementById('modalConfirmacao').addEventListener('hidden.bs.modal', () => { resolve(false); }, { once: true });
            modal.show();
        });
    }

    async function chamarAPI(acao, dados = {}) {
        document.getElementById('loading').style.display = 'flex';
        try {
            const r = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ acao, ...dados }) });
            const j = await r.json();
            document.getElementById('loading').style.display = 'none';
            if (j.erro) { mostrarToast(j.erro, 'error'); return null; }
            return j;
        } catch (e) {
            document.getElementById('loading').style.display = 'none';
            mostrarToast("Erro de conexão", 'error');
            return null;
        }
    }

    async function carregarLista() {
        const dados = await chamarAPI('listarEventos');
        if (!dados) return;
        const ul = document.getElementById('tab-lista-eventos'); ul.innerHTML = '';
        if(dados.length === 0) { ul.innerHTML = '<li class="nav-item"><a class="nav-link disabled">Vazio</a></li>'; return; }
        dados.forEach((ev, idx) => {
            const li = document.createElement('li'); li.className = 'nav-item';
            const a = document.createElement('button'); a.className = idx === 0 ? 'nav-link active' : 'nav-link';
            a.innerText = ev.nome;
            a.onclick = () => { document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active')); a.classList.add('active'); carregarEventoEspecifico(ev.nome); };
            li.appendChild(a); ul.appendChild(li);
        });
        if(dados.length > 0) carregarEventoEspecifico(dados[0].nome);
    }

    async function carregarEventoEspecifico(nome) {
        if (!nome) return;
        eventoAtual = nome; // GARANTE QUE A VARIÁVEL GLOBAL SEJA ATUALIZADA
        const dados = await chamarAPI('obterDadosEvento', { nomeEvento: nome });
        if (!dados) return;
        colunasAtuais = dados.headers; dadosEventoAtual = dados.rows; convidadosSelecionados = [];
        renderizarTabela(dados.headers, dados.rows); atualizarDashboard(dados.headers, dados.rows);
        const temEmail = dados.headers.some(h => h.toLowerCase().trim() === 'email' || h.toLowerCase().trim() === 'e-mail');
        document.getElementById('btn-massa-email').style.display = temEmail ? 'inline-block' : 'none';
        document.getElementById('toolbar-acoes').style.display = 'block'; document.getElementById('toolbar-massa').style.display = 'none';
    }

    function renderizarTabela(headers, rows) {
        const tbody = document.querySelector('#tabela-dados tbody');
        let head = `<tr><th class="ocultar-pdf"><input type="checkbox" onchange="selecionarTodos(this.checked)"></th>`;
        headers.forEach(h => head += `<th>${h}</th>`);
        head += `<th class="text-center ocultar-pdf">Ações</th></tr>`;
        document.querySelector('#tabela-dados thead').innerHTML = head;
        if (rows.length === 0) tbody.innerHTML = `<tr><td colspan="${headers.length + 2}" class="text-center p-4">Vazio</td></tr>`;
        else {
            let body = "";
            rows.forEach((row, i) => {
                body += `<tr><td class="ocultar-pdf"><input type="checkbox" class="check-convidado" data-index="${i}" onchange="toggleSelecao(${i})"></td>`;
                row.forEach(cell => body += `<td>${cell}</td>`);
                body += `<td class="text-center ocultar-pdf"><button class="btn btn-sm btn-light text-primary" onclick="abrirModalEditar(${i})"><i class="fas fa-pen"></i></button> <button class="btn btn-sm btn-light text-danger" onclick="confirmarExclusao(${i})"><i class="fas fa-trash"></i></button></td></tr>`;
            });
            tbody.innerHTML = body;
        }
    }

    function selecionarTodos(chk) {
        document.querySelectorAll('.check-convidado').forEach(c => { c.checked = chk; if(chk && !convidadosSelecionados.includes(parseInt(c.dataset.index))) convidadosSelecionados.push(parseInt(c.dataset.index)); });
        if(!chk) convidadosSelecionados = []; atualizarToolbarMassa();
    }
    function toggleSelecao(idx) {
        const chk = document.querySelector(`.check-convidado[data-index="${idx}"]`);
        if(chk.checked) convidadosSelecionados.push(idx); else convidadosSelecionados = convidadosSelecionados.filter(i => i !== idx);
        atualizarToolbarMassa();
    }
    function atualizarToolbarMassa() {
        document.getElementById('toolbar-massa').style.display = convidadosSelecionados.length > 0 ? 'block' : 'none';
        document.getElementById('count-selecionados').innerText = convidadosSelecionados.length;
    }
    async function atualizarEmMassa(status) {
        if(!await confirmarAcao(`Mudar ${convidadosSelecionados.length} convidados?`, `Novo status: ${status}`)) return;
        const idxStatus = colunasAtuais.indexOf("Status");
        for (const idx of convidadosSelecionados) { const d = [...dadosEventoAtual[idx]]; d[idxStatus] = status; await chamarAPI('atualizarConvidado', { nomeEvento: eventoAtual, linha: idx + 2, novosDados: d }); }
        limparSelecao(); carregarEventoEspecifico(eventoAtual);
    }
    function limparSelecao() { convidadosSelecionados = []; document.querySelectorAll('.check-convidado').forEach(c => c.checked = false); atualizarToolbarMassa(); }

    function abrirModalConfig() {
        document.getElementById('input-renomear').value = eventoAtual;
        const ul = document.getElementById('lista-colunas-config'); ul.innerHTML = '';
        colunasAtuais.forEach(col => ul.innerHTML += `<li class="list-group-item d-flex justify-content-between">${col} <button class="btn btn-sm btn-danger" onclick="rmColuna('${col}')"><i class="fas fa-trash"></i></button></li>`);
        new bootstrap.Modal(document.getElementById('modalConfig')).show();
    }
    async function salvarRenomeacao() {
        const novo = document.getElementById('input-renomear').value; if(novo && novo !== eventoAtual) { await chamarAPI('renomearEvento', { nomeAntigo: eventoAtual, nomeNovo: novo }); bootstrap.Modal.getInstance(document.getElementById('modalConfig')).hide(); carregarLista(); }
    }
    async function addColuna() { const c = document.getElementById('input-nova-coluna').value; if(c) { await chamarAPI('adicionarColuna', { nomeEvento: eventoAtual, novaColuna: c }); abrirModalConfig(); carregarEventoEspecifico(eventoAtual); } }
    async function rmColuna(c) { if(await confirmarAcao("Apagar coluna?", "Dados serão perdidos.")) { await chamarAPI('removerColuna', { nomeEvento: eventoAtual, nomeColuna: c }); abrirModalConfig(); carregarEventoEspecifico(eventoAtual); } }

    function abrirModalEmail() { 
        if (!eventoAtual) return mostrarToast("Selecione um evento primeiro!", "warning");
        new bootstrap.Modal(document.getElementById('modalEmail')).show(); 
    }
    
    async function processarEnvioEmails() {
        if (!eventoAtual) return mostrarToast("Evento não definido.", "error");
        
        const r = await chamarAPI('enviarEmails', { 
            nomeEvento: eventoAtual, // GARANTIDO PELO CHECK ACIMA
            indices: convidadosSelecionados, 
            assunto: document.getElementById('email-assunto').value, 
            mensagem: document.getElementById('email-mensagem').value, 
            linkBase: `${GITHUB_PAGES_URL}index.html` 
        });
        if(r && r.sucesso) { mostrarToast(`Enviados: ${r.enviados}, Erros: ${r.erros}`); bootstrap.Modal.getInstance(document.getElementById('modalEmail')).hide(); limparSelecao(); }
    }

    function atualizarDashboard(h, r) {
        const idx = h.indexOf("Status"); let c=0, p=0, rec=0;
        if(idx > -1) r.forEach(row => { if(row[idx]==='Confirmado') c++; else if(row[idx]==='Não vai') rec++; else p++; }); else p = r.length;
        document.getElementById('stat-total').innerText = r.length; document.getElementById('stat-confirmados').innerText = c; document.getElementById('stat-pendentes').innerText = p; document.getElementById('stat-recusados').innerText = rec;
        if(graficoInstance) graficoInstance.destroy();
        graficoInstance = new Chart(document.getElementById('meuGrafico'), { type: 'doughnut', data: { labels: ['Confirmados','Pendentes','Recusados'], datasets:[{ data:[c,p,rec], backgroundColor:['#10b981','#f59e0b','#ef4444'], borderWidth:0 }] } });
    }

    function gerarPDF() { const e=document.getElementById('container-tabela-exportar'); const c=e.cloneNode(true); c.querySelectorAll('.ocultar-pdf').forEach(x=>x.remove()); html2pdf().from(c).save(`Lista_${eventoAtual}.pdf`); }
    function gerarTXT() { let t=`EVENTO: ${eventoAtual}\n\n`+colunasAtuais.join("\t")+"\n"; dadosEventoAtual.forEach(r=>t+=r.join("\t")+"\n"); const b=new Blob([t]); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download="lista.txt"; a.click(); }
    function gerarExcel() { const ws=XLSX.utils.aoa_to_sheet([colunasAtuais,...dadosEventoAtual]); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Lista"); XLSX.writeFile(wb, "lista.xlsx"); }
    
    function abrirModalLink() { const l=`${GITHUB_PAGES_URL}index.html?evento=${encodeURIComponent(eventoAtual)}`; document.getElementById('input-link-gerado').value=l; document.getElementById('btn-abrir-link').href=l; document.getElementById('qrcode').innerHTML=''; new QRCode(document.getElementById('qrcode'),{text:l,width:128,height:128}); new bootstrap.Modal(document.getElementById('modalLink')).show(); }
    function copiarTextoLink() { document.getElementById('input-link-gerado').select(); navigator.clipboard.writeText(document.getElementById('input-link-gerado').value); mostrarToast("Copiado!"); }
    function toggleAreaImportacao(b) { document.getElementById('area-importacao-criacao').style.display = b ? 'block' : 'none'; }
    async function handleCriarEvento(e) { e.preventDefault(); const n=document.getElementById('novo-nome').value; const t=document.getElementById('novo-tipo').value; let d=""; if(t==='Importar') d=document.getElementById('texto-criacao-import').value; const r=await chamarAPI('criarNovoEvento',{nome:n,template:t,dadosImportados:d}); if(r&&r.sucesso){ mostrarTela('dashboard'); carregarLista(); } }
    function abrirModalImport() { new bootstrap.Modal(document.getElementById('modalImport')).show(); }
    async function processarImportacao() { const t=document.getElementById('texto-importacao').value; const h=document.getElementById('check-headers').checked; const m=t.trim().split('\n').map(l=>l.split('\t')); await chamarAPI('importarListaConvidados',{nomeEvento:eventoAtual,matrizDados:m,temCabecalho:h}); carregarEventoEspecifico(eventoAtual); bootstrap.Modal.getInstance(document.getElementById('modalImport')).hide(); }
    function abrirModalAdd() { const f=document.getElementById('form-dinamico'); f.innerHTML=''; colunasAtuais.forEach(c=>{ f.innerHTML+=`<div class="mb-2"><label>${c}</label><input class="form-control input-dinamico"></div>`; }); new bootstrap.Modal(document.getElementById('modalAdd')).show(); }
    async function enviarConvidado() { const v=Array.from(document.querySelectorAll('.input-dinamico')).map(i=>i.value); await chamarAPI('adicionarConvidado',{nomeEvento:eventoAtual,arrayDados:v}); carregarEventoEspecifico(eventoAtual); bootstrap.Modal.getInstance(document.getElementById('modalAdd')).hide(); }
    async function confirmarExclusao(i) { if(await confirmarAcao("Excluir?", "Irreversível.")) { await chamarAPI('excluirConvidado',{nomeEvento:eventoAtual,linha:i+2}); carregarEventoEspecifico(eventoAtual); } }
    function abrirModalEditar(i) { const d=dadosEventoAtual[i]; document.getElementById('edit-linha-index').value=i; const f=document.getElementById('form-editar-dinamico'); f.innerHTML=''; colunasAtuais.forEach((c,idx)=>{ f.innerHTML+=`<div class="mb-2"><label>${c}</label><input class="form-control input-editar" value="${d[idx]}"></div>`; }); new bootstrap.Modal(document.getElementById('modalEditar')).show(); }
    async function salvarEdicao() { const i=parseInt(document.getElementById('edit-linha-index').value); const v=Array.from(document.querySelectorAll('.input-editar')).map(x=>x.value); await chamarAPI('atualizarConvidado',{nomeEvento:eventoAtual,linha:i+2,novosDados:v}); carregarEventoEspecifico(eventoAtual); bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide(); }
    function filtrarTabela() { const q=document.getElementById('busca-rapida').value.toLowerCase(); document.querySelectorAll('#tabela-dados tbody tr').forEach(r=>r.style.display=r.innerText.toLowerCase().includes(q)?'':'none'); }
    function mostrarTela(t) { document.getElementById('tela-dashboard').style.display=t==='dashboard'?'block':'none'; document.getElementById('tela-novo').style.display=t==='novo'?'block':'none'; }
</script>
</body>
</html>
