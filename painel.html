<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Eventos - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-blue: #1e3a8a;
            --primary-light: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.15);
        }

        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .sidebar { height: 100vh; background: white; border-right: 1px solid #dee2e6; position: fixed; width: 250px; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.07); }
        .content { margin-left: 250px; padding: 30px; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(4px); }
        
        .card-stat { border: none; border-radius: 16px; transition: transform 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card-stat:hover { transform: translateY(-4px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        .stat-icon { font-size: 2.5rem; opacity: 0.15; position: absolute; right: 15px; top: 15px; }
        .btn-action { width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; }
        .btn-action:hover { transform: scale(1.1); }
        
        .nav-tabs { border-bottom: 2px solid #e9ecef; margin-bottom: 20px; }
        .nav-tabs .nav-link { color: #495057; font-weight: 500; border: none; border-bottom: 3px solid transparent; background: transparent; padding: 12px 20px; transition: all 0.2s; }
        .nav-tabs .nav-link:hover { color: var(--primary-light); }
        .nav-tabs .nav-link.active { color: var(--primary-light); font-weight: bold; border-bottom: 3px solid var(--primary-light); }
        
        #qrcode { display: flex; justify-content: center; margin: 20px 0; }
        .ocultar-pdf { display: table-cell; }
        
        .btn { transition: all 0.2s; border-radius: 10px; font-weight: 500; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.07); }
        .btn:active { transform: translateY(0); }
        
        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 20px; font-weight: 600; font-size: 0.8rem; }
        
        .toolbar-search { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .search-input { border-radius: 10px; border: 2px solid #e5e7eb; padding: 10px 16px; transition: all 0.2s; }
        .search-input:focus { border-color: var(--primary-light); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast-notification { background: white; padding: 16px 20px; border-radius: 12px; box-shadow: var(--shadow-xl); display: flex; align-items: center; gap: 12px; margin-bottom: 10px; animation: slideIn 0.3s; min-width: 320px; }
        .toast-notification.slide-out { animation: slideOut 0.3s; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { to { transform: translateX(400px); opacity: 0; } }
        
        .toast-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        .toast-icon.success { background: var(--success); color: white; }
        .toast-icon.error { background: var(--danger); color: white; }
        .toast-icon.warning { background: var(--warning); color: white; }
        .toast-message { color: #374151; font-weight: 500; flex-grow: 1; }
        
        .modal-content { border: none; border-radius: 16px; box-shadow: var(--shadow-xl); }
        .modal-header { border-top-left-radius: 16px; border-top-right-radius: 16px; padding: 20px 24px; }
        .modal-body { padding: 24px; }
        
        .table thead th { background-color: #f8f9fa; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; padding: 16px 12px; border-bottom: 2px solid #e9ecef; }
        .table tbody tr { transition: all 0.2s; }
        .table tbody tr:hover { background-color: #f8f9fa; }
        
        .sidebar .btn { border-radius: 10px; padding: 12px 16px; transition: all 0.2s; text-align: left; }
        .sidebar .btn:hover { background-color: #f3f4f6; transform: translateX(4px); }
        .sidebar .btn.active { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-light) 100%); color: white; }
        
        .metrics-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .metric-item { text-align: center; padding: 12px; }
        .metric-value { font-size: 2rem; font-weight: 700; color: var(--primary-blue); }
        .metric-label { font-size: 0.875rem; color: #6b7280; text-transform: uppercase; }
        
        /* NOVO: Toolbar de Sele√ß√£o em Massa */
        .toolbar-massa { 
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); 
            border-left: 4px solid var(--primary-blue);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .check-convidado { cursor: pointer; width: 18px; height: 18px; }
        
        @media (max-width: 768px) {
            .sidebar { width: 100%; height: auto; position: relative; }
            .content { margin-left: 0; padding: 15px; }
            #toast-container { right: 10px; left: 10px; }
            .toast-notification { min-width: auto; }
        }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;"></div>
    <span class="mt-3 fw-bold text-secondary fs-5">Carregando...</span>
</div>

<div class="sidebar p-4 d-flex flex-column">
    <h5 class="text-primary mb-4 fw-bold">
        <i class="fas fa-calendar-check me-2"></i>Gestor RSVP
    </h5>
    <div class="d-grid gap-2">
        <button class="btn btn-light active fw-semibold" onclick="mostrarTela('dashboard')">
            <i class="fas fa-chart-pie me-2 text-primary"></i>Dashboard
        </button>
        <button class="btn btn-light fw-semibold" onclick="mostrarTela('novo')">
            <i class="fas fa-plus me-2 text-success"></i>Novo Evento
        </button>
    </div>
    <div class="mt-auto text-muted small pt-3 border-top">
        <div class="d-flex align-items-center justify-content-between">
            <span>v13.0 - Pro++</span>
            <i class="fas fa-rocket text-primary"></i>
        </div>
    </div>
</div>

<div class="content">
    
    <div id="tela-dashboard">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold text-dark m-0">Painel de Controle</h3>
            <button class="btn btn-light text-secondary" onclick="carregarEventoEspecifico(eventoAtual)" title="Atualizar">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>

        <div class="d-flex align-items-center mb-4">
            <ul class="nav nav-tabs flex-grow-1" id="tab-lista-eventos">
                <li class="nav-item"><a class="nav-link disabled">Carregando eventos...</a></li>
            </ul>
        </div>

        <div id="area-stats" style="display:none;">
            <div class="row mb-4 g-3">
                <div class="col-md-3"><div class="card card-stat bg-white text-dark"><div class="card-body position-relative"><i class="fas fa-users stat-icon text-primary"></i><h6 class="text-uppercase text-muted small fw-bold">Total</h6><h2 class="fw-bold mb-0" id="stat-total">0</h2></div></div></div>
                <div class="col-md-3"><div class="card card-stat bg-success text-white"><div class="card-body position-relative"><i class="fas fa-check-circle stat-icon text-white"></i><h6 class="text-uppercase text-white-50 small fw-bold">Confirmados</h6><h2 class="fw-bold mb-0" id="stat-confirmados">0</h2></div></div></div>
                <div class="col-md-3"><div class="card card-stat bg-warning text-dark"><div class="card-body position-relative"><i class="fas fa-clock stat-icon text-dark"></i><h6 class="text-uppercase text-muted small fw-bold">Pendentes</h6><h2 class="fw-bold mb-0" id="stat-pendentes">0</h2></div></div></div>
                <div class="col-md-3"><div class="card card-stat bg-danger text-white"><div class="card-body position-relative"><i class="fas fa-times-circle stat-icon text-white"></i><h6 class="text-uppercase text-white-50 small fw-bold">Recusados</h6><h2 class="fw-bold mb-0" id="stat-recusados">0</h2></div></div></div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="metrics-card">
                        <h6 class="text-center text-muted mb-3 fw-semibold">M√©tricas</h6>
                        <div class="row">
                            <div class="col-6 metric-item border-end">
                                <div class="metric-value" id="taxa-resposta">0%</div>
                                <div class="metric-label">Taxa Resposta</div>
                            </div>
                            <div class="col-6 metric-item">
                                <div class="metric-value text-success" id="percentual-confirmados">0%</div>
                                <div class="metric-label">% Confirmados</div>
                            </div>
                        </div>
                        <div class="text-center mt-3 pt-3 border-top">
                            <small class="text-muted"><i class="fas fa-clock me-1"></i>Atualizado: <span id="ultima-atualizacao">-</span></small>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card border-0 shadow-sm" style="border-radius: 16px;">
                        <div class="card-body">
                            <h6 class="text-center text-muted mb-3 fw-semibold">Vis√£o Geral</h6>
                            <div style="height: 220px; position: relative;">
                                <canvas id="meuGrafico"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NOVO: Toolbar de Sele√ß√£o em Massa -->
        <div id="toolbar-massa" class="toolbar-massa">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                <div>
                    <strong><i class="fas fa-check-square me-2"></i><span id="count-selecionados">0</span> selecionados</strong>
                </div>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-success" onclick="atualizarEmMassa('Confirmado')">
                        <i class="fas fa-check me-1"></i>Confirmar
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="atualizarEmMassa('Pendente')">
                        <i class="fas fa-clock me-1"></i>Pendente
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="atualizarEmMassa('N√£o vai')">
                        <i class="fas fa-times me-1"></i>Recusar
                    </button>
                </div>
                <button class="btn btn-sm btn-light" onclick="limparSelecao()">
                    <i class="fas fa-times me-1"></i>Limpar
                </button>
            </div>
        </div>

        <div id="toolbar-busca" class="toolbar-search" style="display:none;">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="busca-rapida" class="form-control border-start-0 search-input" placeholder="Buscar... (Ctrl+K)" onkeyup="filtrarTabela()">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select search-input" onchange="filtrarPorStatus(this.value)">
                        <option value="">Todos</option>
                        <option value="Confirmado">‚úì Confirmados</option>
                        <option value="Pendente">‚è± Pendentes</option>
                        <option value="N√£o vai">‚úï Recusados</option>
                    </select>
                </div>
                <div class="col-md-3 text-end">
                    <span class="text-muted small"><i class="fas fa-filter me-1"></i><span id="contador-filtrados">0</span> resultados</span>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0" style="border-radius: 16px;">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between mb-4 align-items-center pb-3 flex-wrap gap-3">
                    <h5 class="m-0 text-muted fw-semibold" id="titulo-tabela"><i class="fas fa-list me-2"></i>Detalhes</h5>
                    
                    <div id="toolbar-acoes" style="display:none;">
                        <div class="btn-group me-2" role="group">
                            <button class="btn btn-outline-danger" onclick="gerarPDF()"><i class="fas fa-file-pdf me-1"></i> PDF</button>
                            <button class="btn btn-outline-secondary" onclick="gerarTXT()"><i class="fas fa-file-alt me-1"></i> TXT</button>
                            <button class="btn btn-outline-success" onclick="gerarExcel()"><i class="fas fa-file-excel me-1"></i> Excel</button>
                        </div>
                        <button class="btn btn-outline-primary me-2" onclick="abrirModalLink()"><i class="fas fa-qrcode me-2"></i>Link</button>
                        <button class="btn btn-success me-2" onclick="abrirModalImport()"><i class="fas fa-file-excel me-2"></i>Importar</button>
                        <button class="btn btn-primary" onclick="abrirModalAdd()"><i class="fas fa-user-plus me-2"></i>Novo</button>
                    </div>
                </div>

                <div id="container-tabela-exportar" class="table-responsive">
                    <table class="table table-hover align-middle" id="tabela-dados">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="tela-novo" style="display:none;">
        <h3 class="fw-bold mb-4"><i class="fas fa-plus-circle text-success me-2"></i>Criar Novo Evento</h3>
        <div class="row">
            <div class="col-md-8">
                <div class="card shadow-sm border-0" style="border-radius: 16px;">
                    <div class="card-body p-4">
                        <form onsubmit="handleCriarEvento(event)">
                            <div class="mb-4">
                                <label class="form-label fw-bold">Nome do Evento</label>
                                <input type="text" id="novo-nome" class="form-control form-control-lg" placeholder="Ex: Festa 2024" required>
                            </div>
                            <div class="mb-4">
                                <label class="form-label fw-bold">Modelo</label>
                                <div class="list-group mb-3">
                                    <label class="list-group-item list-group-item-action d-flex gap-3 py-3 bg-light" style="cursor: pointer; border-radius: 10px; margin-bottom: 10px;">
                                        <input class="form-check-input" type="radio" name="novo-tipo" value="Importar" onchange="toggleAreaImportacao(true)">
                                        <div><strong><i class="fas fa-file-excel text-success me-2"></i>Importar Excel</strong><br><small class="text-muted">Cole dados do Excel</small></div>
                                    </label>
                                    <label class="list-group-item list-group-item-action d-flex gap-3 py-3" style="cursor: pointer; border-radius: 10px; margin-bottom: 10px;">
                                        <input class="form-check-input" type="radio" name="novo-tipo" value="Casamento" checked onchange="toggleAreaImportacao(false)">
                                        <div><strong>üíç Casamento</strong><br><small class="text-muted">Mesa, restri√ß√£o, acompanhantes</small></div>
                                    </label>
                                    <label class="list-group-item list-group-item-action d-flex gap-3 py-3" style="cursor: pointer; border-radius: 10px;">
                                        <input class="form-check-input" type="radio" name="novo-tipo" value="Basico" onchange="toggleAreaImportacao(false)">
                                        <div><strong>üìù B√°sico</strong><br><small class="text-muted">Nome, telefone, status</small></div>
                                    </label>
                                </div>
                                <div id="area-importacao-criacao" class="p-3 bg-light border rounded-3" style="display:none;">
                                    <textarea id="texto-criacao-import" class="form-control mb-2" rows="8" placeholder="Cole aqui..."></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg w-100"><i class="fas fa-rocket me-2"></i>Criar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAIS -->
<div class="modal fade" id="modalLink" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title"><i class="fas fa-qrcode me-2"></i>Compartilhar</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body text-center p-4"><div id="qrcode" class="mb-3"></div><p class="small text-muted mb-4"><i class="fas fa-mobile-alt me-1"></i>Escaneie ou compartilhe</p><div class="input-group mb-3"><input type="text" id="input-link-gerado" class="form-control text-center fw-semibold" readonly><button class="btn btn-outline-primary" onclick="copiarTextoLink()"><i class="fas fa-copy"></i></button></div><div class="d-grid gap-2 mt-3"><button class="btn btn-success" onclick="compartilharWhatsApp()"><i class="fab fa-whatsapp me-2"></i>Compartilhar via WhatsApp</button><button class="btn btn-primary" onclick="compartilharEmail()"><i class="fas fa-envelope me-2"></i>Enviar por Email</button><a id="btn-abrir-link" href="#" target="_blank" class="btn btn-light"><i class="fas fa-external-link-alt me-1"></i>Abrir</a></div></div></div></div></div>
<div class="modal fade" id="modalEditar" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title text-dark"><i class="fas fa-edit me-2"></i>Editar</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="edit-linha-index"><div id="form-editar-dinamico"></div></div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button class="btn btn-warning fw-bold" onclick="salvarEdicao()"><i class="fas fa-save me-1"></i>Salvar</button></div></div></div></div>
<div class="modal fade" id="modalAdd" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Adicionar</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="form-dinamico"></div><div class="modal-footer"><button class="btn btn-primary fw-bold" onclick="enviarConvidado()"><i class="fas fa-check me-1"></i>Salvar</button></div></div></div></div>
<div class="modal fade" id="modalImport" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title"><i class="fas fa-file-excel me-2"></i>Importar</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" id="check-headers" checked><label class="form-check-label fw-semibold"><i class="fas fa-table me-1"></i>1¬™ linha √© cabe√ßalho</label></div><textarea id="texto-importacao" class="form-control" rows="10" placeholder="Cole..."></textarea></div><div class="modal-footer"><button class="btn btn-success fw-bold" onclick="processarImportacao()"><i class="fas fa-upload me-1"></i>Processar</button></div></div></div></div>
<div class="modal fade" id="modalConfirmacao" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg"><div class="modal-body text-center p-5"><div class="mb-4"><i class="fas fa-exclamation-triangle text-warning" style="font-size: 4rem;"></i></div><h4 class="fw-bold mb-3" id="confirm-titulo">Confirmar?</h4><p class="text-muted" id="confirm-mensagem">Esta a√ß√£o n√£o pode ser desfeita.</p><div class="d-flex gap-3 mt-4"><button class="btn btn-light flex-fill" data-bs-dismiss="modal">Cancelar</button><button class="btn btn-danger flex-fill fw-bold" id="confirm-btn-ok">Confirmar</button></div></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbznlB0UzqjzlkneSPFv1mi_0Jqqtv6DkZsbPctw28isyZvAwyXOBv2tHnQUl1SM1QQ/exec"; 
    const GITHUB_PAGES_URL = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);

    let colunasAtuais = [];
    let dadosEventoAtual = []; 
    let eventoAtual = "";
    let graficoInstance = null;
    let convidadosSelecionados = []; // NOVO

    document.addEventListener('DOMContentLoaded', () => { carregarLista(); });

    function mostrarToast(mensagem, tipo = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†' };
        toast.className = 'toast-notification';
        toast.innerHTML = `<span class="toast-icon ${tipo}">${icons[tipo]}</span><span class="toast-message">${mensagem}</span>`;
        container.appendChild(toast);
        setTimeout(() => { toast.classList.add('slide-out'); setTimeout(() => toast.remove(), 300); }, 3500);
    }

    function confirmarAcao(titulo, mensagem) {
        return new Promise((resolve) => {
            document.getElementById('confirm-titulo').innerText = titulo;
            document.getElementById('confirm-mensagem').innerText = mensagem;
            const modal = new bootstrap.Modal(document.getElementById('modalConfirmacao'));
            const btnOk = document.getElementById('confirm-btn-ok');
            btnOk.onclick = () => { modal.hide(); resolve(true); };
            document.getElementById('modalConfirmacao').addEventListener('hidden.bs.modal', () => { resolve(false); }, { once: true });
            modal.show();
        });
    }

    async function chamarAPI(acao, dados = {}) {
        document.getElementById('loading').style.display = 'flex';
        try {
            const response = await fetch(API_URL, { method: 'POST', headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify({ acao, ...dados }) });
            const json = await response.json();
            document.getElementById('loading').style.display = 'none';
            if (json.erro) { mostrarToast("Erro: " + json.erro, "error"); return null; }
            return json;
        } catch (e) {
            document.getElementById('loading').style.display = 'none';
            mostrarToast("Erro de conex√£o.", "error");
            return null;
        }
    }

    async function carregarLista() {
        const dados = await chamarAPI('listarEventos');
        if (!dados) return;
        const tabContainer = document.getElementById('tab-lista-eventos');
        tabContainer.innerHTML = ''; 
        if (dados.length === 0) { tabContainer.innerHTML = '<li class="nav-item"><a class="nav-link disabled">Nenhum evento</a></li>'; return; }
        dados.forEach((ev, index) => {
            const li = document.createElement('li'); li.className = 'nav-item';
            const btn = document.createElement('button'); btn.className = index === 0 ? 'nav-link active' : 'nav-link';
            btn.innerText = ev.nome; btn.onclick = () => { document.querySelectorAll('#tab-lista-eventos .nav-link').forEach(el => el.classList.remove('active')); btn.classList.add('active'); carregarEventoEspecifico(ev.nome); };
            li.appendChild(btn); tabContainer.appendChild(li);
        });
        if (dados.length > 0) carregarEventoEspecifico(dados[0].nome);
    }

    async function carregarEventoEspecifico(nome) {
        if (!nome) return;
        eventoAtual = nome;
        const dados = await chamarAPI('obterDadosEvento', { nomeEvento: nome });
        if (!dados) return;
        colunasAtuais = dados.headers;
        dadosEventoAtual = dados.rows;
        convidadosSelecionados = []; // Reset
        atualizarDashboard(dados.headers, dados.rows);
        renderizarTabela(dados.headers, dados.rows);
        document.getElementById('toolbar-acoes').style.display = 'block';
        document.getElementById('toolbar-busca').style.display = 'block';
        document.getElementById('toolbar-massa').style.display = 'none';
        document.getElementById('busca-rapida').value = '';
        document.querySelector('select.form-select').value = '';
        mostrarToast(`Evento "${nome}" carregado!`, "success");
    }

    function atualizarDashboard(headers, rows) {
        document.getElementById('area-stats').style.display = 'block';
        const indexStatus = headers.indexOf('Status');
        let confirmados = 0, pendentes = 0, recusados = 0, total = rows.length;
        if (indexStatus > -1) {
            rows.forEach(row => {
                const status = row[indexStatus] || "Pendente";
                if (status === 'Confirmado') confirmados++; else if (status === 'N√£o vai') recusados++; else pendentes++;
            });
        } else { pendentes = total; }
        document.getElementById('stat-total').innerText = total; 
        document.getElementById('stat-confirmados').innerText = confirmados; 
        document.getElementById('stat-pendentes').innerText = pendentes; 
        document.getElementById('stat-recusados').innerText = recusados;
        const taxaResposta = total > 0 ? Math.round(((confirmados + recusados) / total) * 100) : 0;
        const percentualConfirmados = total > 0 ? Math.round((confirmados / total) * 100) : 0;
        document.getElementById('taxa-resposta').innerText = taxaResposta + '%';
        document.getElementById('percentual-confirmados').innerText = percentualConfirmados + '%';
        document.getElementById('ultima-atualizacao').innerText = new Date().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
        const ctx = document.getElementById('meuGrafico').getContext('2d');
        if (graficoInstance) graficoInstance.destroy();
        graficoInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['Confirmados', 'Pendentes', 'Recusados'], datasets: [{ data: [confirmados, pendentes, recusados], backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], borderWidth: 0, hoverOffset: 10 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 15, font: { size: 13 } } } } } });
    }

    function filtrarTabela() {
        const termo = document.getElementById('busca-rapida').value.toLowerCase();
        const linhas = document.querySelectorAll('#tabela-dados tbody tr');
        let contador = 0;
        linhas.forEach(linha => {
            const texto = linha.textContent.toLowerCase();
            const visivel = texto.includes(termo);
            linha.style.display = visivel ? '' : 'none';
            if (visivel) contador++;
        });
        document.getElementById('contador-filtrados').innerText = contador;
    }

    function filtrarPorStatus(status) {
        const linhas = document.querySelectorAll('#tabela-dados tbody tr');
        const indexStatus = colunasAtuais.indexOf('Status');
        let contador = 0;
        linhas.forEach(linha => {
            const celulas = linha.querySelectorAll('td');
            const statusCelula = celulas[indexStatus + 1]?.textContent.replace(/[^a-z√°√©√≠√≥√∫√†√¢√™√¥√£√µ√ß\s]/gi, '').trim();
            const visivel = !status || statusCelula.includes(status);
            linha.style.display = visivel ? '' : 'none';
            if (visivel) contador++;
        });
        document.getElementById('contador-filtrados').innerText = contador;
    }

    function renderizarTabela(headers, rows) {
        const thead = document.querySelector('#tabela-dados thead');
        const tbody = document.querySelector('#tabela-dados tbody');
        
        // NOVO: Checkbox na primeira coluna
        let headerHTML = "<tr><th class='ocultar-pdf' style='width: 40px;'><input type='checkbox' onchange='selecionarTodos(this.checked)'></th>";
        headers.forEach(h => headerHTML += `<th>${h}</th>`);
        headerHTML += `<th class="text-center ocultar-pdf" style="width: 100px;">A√ß√µes</th></tr>`;
        thead.innerHTML = headerHTML;
        
        if (rows.length === 0) { 
            tbody.innerHTML = `<tr><td colspan="${headers.length + 2}" class="text-center p-5"><i class="fas fa-inbox fa-3x text-muted mb-3 d-block"></i><span class="text-muted">Nenhum convidado</span></td></tr>`; 
            document.getElementById('contador-filtrados').innerText = '0';
        } else {
            const statusBadges = {
                'Confirmado': '<span class="status-badge bg-success text-white"><i class="fas fa-check"></i>Confirmado</span>',
                'Pendente': '<span class="status-badge bg-warning text-dark"><i class="fas fa-clock"></i>Pendente</span>',
                'N√£o vai': '<span class="status-badge bg-danger text-white"><i class="fas fa-times"></i>N√£o vai</span>'
            };
            const indexStatus = headers.indexOf('Status');
            let bodyHTML = "";
            rows.forEach((row, index) => {
                bodyHTML += "<tr>";
                // NOVO: Checkbox
                bodyHTML += `<td class="ocultar-pdf"><input type="checkbox" class="check-convidado" data-index="${index}" onchange="toggleSelecao(${index})"></td>`;
                row.forEach((cell, colIndex) => {
                    if (colIndex === indexStatus && statusBadges[cell]) {
                        bodyHTML += `<td>${statusBadges[cell]}</td>`;
                    } else {
                        bodyHTML += `<td>${cell}</td>`;
                    }
                });
                bodyHTML += `<td class="text-center ocultar-pdf">
                    <button class="btn btn-light btn-action text-primary me-1" onclick="abrirModalEditar(${index})"><i class="fas fa-pen"></i></button>
                </td></tr>`;
            });
            tbody.innerHTML = bodyHTML;
            document.getElementById('contador-filtrados').innerText = rows.length;
        }
    }

    // NOVO: Fun√ß√µes de Sele√ß√£o em Massa
    function selecionarTodos(checked) {
        convidadosSelecionados = [];
        document.querySelectorAll('.check-convidado').forEach(checkbox => {
            checkbox.checked = checked;
            if (checked) {
                convidadosSelecionados.push(parseInt(checkbox.dataset.index));
            }
        });
        atualizarToolbarMassa();
    }

    function toggleSelecao(index) {
        const checkbox = document.querySelector(`.check-convidado[data-index="${index}"]`);
        if (checkbox.checked) {
            if (!convidadosSelecionados.includes(index)) {
                convidadosSelecionados.push(index);
            }
        } else {
            convidadosSelecionados = convidadosSelecionados.filter(i => i !== index);
        }
        atualizarToolbarMassa();
    }

    function atualizarToolbarMassa() {
        const toolbar = document.getElementById('toolbar-massa');
        const count = document.getElementById('count-selecionados');
        count.innerText = convidadosSelecionados.length;
        toolbar.style.display = convidadosSelecionados.length > 0 ? 'block' : 'none';
    }

    async function atualizarEmMassa(novoStatus) {
        if (convidadosSelecionados.length === 0) return;
        
        const confirmado = await confirmarAcao(
            `Atualizar ${convidadosSelecionados.length} convidados?`,
            `Todos ser√£o marcados como "${novoStatus}"`
        );
        
        if (!confirmado) return;
        
        const indexStatus = colunasAtuais.indexOf('Status');
        for (const index of convidadosSelecionados) {
            const novosDados = [...dadosEventoAtual[index]];
            novosDados[indexStatus] = novoStatus;
            await chamarAPI('atualizarConvidado', { nomeEvento: eventoAtual, linha: index + 2, novosDados });
        }
        
        limparSelecao();
        carregarEventoEspecifico(eventoAtual);
        mostrarToast(`${convidadosSelecionados.length} atualizados!`, "success");
    }

    function limparSelecao() {
        convidadosSelecionados = [];
        document.querySelectorAll('.check-convidado').forEach(cb => cb.checked = false);
        document.querySelector('thead input[type="checkbox"]').checked = false;
        atualizarToolbarMassa();
    }

    // PDF CORRIGIDO - Sem cortes
    function gerarPDF() {
        const elemento = document.getElementById('container-tabela-exportar');
        const clone = elemento.cloneNode(true);
        clone.querySelectorAll('.ocultar-pdf').forEach(el => el.remove());
        
        // Criar wrapper com melhor formata√ß√£o
        const wrapper = document.createElement('div');
        wrapper.style.padding = '30px';
        wrapper.style.fontSize = '11px'; // Fonte menor para caber melhor
        
        wrapper.innerHTML = `
            <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #1e3a8a; padding-bottom: 15px;">
                <h1 style="color: #1e3a8a; font-family: sans-serif; margin: 0; font-size: 24px;">${eventoAtual}</h1>
                <p style="color: #6b7280; font-family: sans-serif; font-size: 12px; margin: 5px 0 0 0;">
                    Relat√≥rio gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}
                </p>
            </div>
            <div style="margin-bottom: 20px;">
                <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 5px; border: 1px solid #ddd;"><strong>Total:</strong> ${document.getElementById('stat-total').innerText}</td>
                        <td style="padding: 5px; border: 1px solid #ddd;"><strong>Confirmados:</strong> ${document.getElementById('stat-confirmados').innerText}</td>
                        <td style="padding: 5px; border: 1px solid #ddd;"><strong>Pendentes:</strong> ${document.getElementById('stat-pendentes').innerText}</td>
                        <td style="padding: 5px; border: 1px solid #ddd;"><strong>Recusados:</strong> ${document.getElementById('stat-recusados').innerText}</td>
                    </tr>
                </table>
            </div>
        `;
        
        // Ajustar tamanho da tabela
        const tabelaClone = clone.querySelector('table');
        tabelaClone.style.fontSize = '10px';
        tabelaClone.style.width = '100%';
        
        // Ajustar c√©lulas
        clone.querySelectorAll('th, td').forEach(cell => {
            cell.style.padding = '6px 4px';
            cell.style.fontSize = '10px';
            cell.style.wordBreak = 'break-word';
        });
        
        wrapper.appendChild(clone);

        const opt = {
            margin: [15, 10, 15, 10], // top, left, bottom, right em mm
            filename: `${eventoAtual}_${new Date().toISOString().split('T')[0]}.pdf`,
            image: { type: 'jpeg', quality: 0.95 },
            html2canvas: { 
                scale: 2,
                useCORS: true,
                letterRendering: true
            },
            jsPDF: { 
                unit: 'mm', 
                format: 'a4', 
                orientation: 'landscape' // LANDSCAPE para tabelas largas!
            }
        };

        html2pdf().set(opt).from(wrapper).save().then(() => {
            mostrarToast("PDF gerado!", "success");
        });
    }

    function gerarTXT() {
        let texto = `======================================\n`;
        texto += `RELAT√ìRIO: ${eventoAtual}\n`;
        texto += `Gerado: ${new Date().toLocaleString('pt-BR')}\n`;
        texto += `======================================\n\n`;
        texto += `RESUMO:\n`;
        texto += `Total: ${document.getElementById('stat-total').innerText}\n`;
        texto += `Confirmados: ${document.getElementById('stat-confirmados').innerText}\n`;
        texto += `Pendentes: ${document.getElementById('stat-pendentes').innerText}\n`;
        texto += `Recusados: ${document.getElementById('stat-recusados').innerText}\n`;
        texto += `\n======================================\n\n`;
        texto += colunasAtuais.join("\t") + "\n";
        texto += "-".repeat(80) + "\n";
        dadosEventoAtual.forEach(linha => texto += linha.join("\t") + "\n");
        const blob = new Blob([texto], { type: 'text/plain;charset=utf-8' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${eventoAtual}_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        window.URL.revokeObjectURL(url);
        mostrarToast("TXT baixado!", "success");
    }

    function gerarExcel() {
        const ws = XLSX.utils.aoa_to_sheet([colunasAtuais, ...dadosEventoAtual]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, eventoAtual.substring(0, 31));
        XLSX.writeFile(wb, `${eventoAtual}_${new Date().toISOString().split('T')[0]}.xlsx`);
        mostrarToast("Excel gerado!", "success");
    }

    function abrirModalEditar(rowIndex) { 
        const dadosRow = dadosEventoAtual[rowIndex]; 
        document.getElementById('edit-linha-index').value = rowIndex; 
        const form = document.getElementById('form-editar-dinamico'); 
        form.innerHTML = ""; 
        colunasAtuais.forEach((col, colIndex) => { 
            const valorAtual = dadosRow[colIndex]; 
            let inputHTML = col === 'Status' 
                ? `<select class="form-control input-editar"><option value="Pendente" ${valorAtual === 'Pendente' ? 'selected' : ''}>Pendente</option><option value="Confirmado" ${valorAtual === 'Confirmado' ? 'selected' : ''}>Confirmado</option><option value="N√£o vai" ${valorAtual === 'N√£o vai' ? 'selected' : ''}>N√£o vai</option></select>` 
                : `<input type="text" class="form-control input-editar" value="${valorAtual}">`; 
            form.innerHTML += `<div class="mb-3"><label class="fw-bold small text-muted">${col}</label>${inputHTML}</div>`; 
        }); 
        new bootstrap.Modal(document.getElementById('modalEditar')).show(); 
    }

    async function salvarEdicao() { 
        const rowIndex = parseInt(document.getElementById('edit-linha-index').value); 
        const inputs = document.querySelectorAll('.input-editar'); 
        const novosDados = Array.from(inputs).map(i => i.value); 
        bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide(); 
        const res = await chamarAPI('atualizarConvidado', { nomeEvento: eventoAtual, linha: rowIndex + 2, novosDados }); 
        if (res && res.sucesso) { carregarEventoEspecifico(eventoAtual); mostrarToast("Atualizado!", "success"); }
    }

    // NOVO: Compartilhamento
    function abrirModalLink() { 
        if (!eventoAtual) return; 
        const link = `${GITHUB_PAGES_URL}index.html?evento=${encodeURIComponent(eventoAtual)}`; 
        document.getElementById('input-link-gerado').value = link; 
        document.getElementById('btn-abrir-link').href = link; 
        const qr = document.getElementById('qrcode'); 
        qr.innerHTML = ""; 
        new QRCode(qr, { text: link, width: 180, height: 180, colorDark: "#1e3a8a" }); 
        new bootstrap.Modal(document.getElementById('modalLink')).show(); 
    }

    function copiarTextoLink() { 
        const input = document.getElementById('input-link-gerado'); 
        input.select(); 
        navigator.clipboard.writeText(input.value); 
        mostrarToast("Link copiado!", "success"); 
    }

    function compartilharWhatsApp() {
        const link = document.getElementById('input-link-gerado').value;
        const mensagem = `Ol√°! Confirme sua presen√ßa em *${eventoAtual}*:\n\n${link}`;
        const whatsappURL = `https://wa.me/?text=${encodeURIComponent(mensagem)}`;
        window.open(whatsappURL, '_blank');
    }

    function compartilharEmail() {
        const link = document.getElementById('input-link-gerado').value;
        const assunto = `Confirma√ß√£o - ${eventoAtual}`;
        const corpo = `Ol√°!\n\nConfirme sua presen√ßa em ${eventoAtual}:\n\n${link}\n\nObrigado!`;
        const mailtoURL = `mailto:?subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(corpo)}`;
        window.location.href = mailtoURL;
    }

    function toggleAreaImportacao(mostrar) { document.getElementById('area-importacao-criacao').style.display = mostrar ? 'block' : 'none'; }
    
    async function handleCriarEvento(e) { 
        e.preventDefault(); 
        const nome = document.getElementById('novo-nome').value.trim(); 
        const tipo = document.querySelector('input[name="novo-tipo"]:checked').value; 
        let dados = tipo === 'Importar' ? document.getElementById('texto-criacao-import').value : ""; 
        if (tipo === 'Importar' && !dados.trim()) { mostrarToast("Cole os dados.", "warning"); return; }
        const res = await chamarAPI('criarNovoEvento', { nome, template: tipo, dadosImportados: dados }); 
        if (res && res.sucesso) { mostrarToast(`"${nome}" criado!`, "success"); mostrarTela('dashboard'); carregarLista(); }
    }
    
    function abrirModalImport() { document.getElementById('texto-importacao').value = ""; new bootstrap.Modal(document.getElementById('modalImport')).show(); }
    
    async function processarImportacao() { 
        const texto = document.getElementById('texto-importacao').value; 
        const temCabecalho = document.getElementById('check-headers').checked; 
        if (!texto.trim()) { mostrarToast("Cole os dados.", "warning"); return; }
        const linhas = texto.trim().split('\n'); 
        const matriz = linhas.map(l => l.split('\t')); 
        bootstrap.Modal.getInstance(document.getElementById('modalImport')).hide(); 
        const res = await chamarAPI('importarListaConvidados', { nomeEvento: eventoAtual, matrizDados: matriz, temCabecalho }); 
        if (res && res.sucesso) { carregarEventoEspecifico(eventoAtual); mostrarToast(`${res.qtd} importados!`, "success"); }
    }
    
    function abrirModalAdd() { 
        const form = document.getElementById('form-dinamico'); 
        form.innerHTML = ""; 
        colunasAtuais.forEach(col => { 
            let inputHTML = col === 'Status' ? `<select class="form-control input-dinamico"><option>Pendente</option><option>Confirmado</option><option>N√£o vai</option></select>` : `<input type="text" class="form-control input-dinamico">`; 
            form.innerHTML += `<div class="mb-3"><label class="fw-bold small text-muted">${col}</label>${inputHTML}</div>`; 
        }); 
        new bootstrap.Modal(document.getElementById('modalAdd')).show(); 
    }
    
    async function enviarConvidado() { 
        const valores = Array.from(document.querySelectorAll('.input-dinamico')).map(i => i.value); 
        if (valores[0] && valores[0].trim() === '') { mostrarToast("Nome obrigat√≥rio.", "warning"); return; }
        bootstrap.Modal.getInstance(document.getElementById('modalAdd')).hide(); 
        const res = await chamarAPI('adicionarConvidado', { nomeEvento: eventoAtual, arrayDados: valores }); 
        if (res && res.sucesso) { carregarEventoEspecifico(eventoAtual); mostrarToast("Adicionado!", "success"); }
    }
    
    function mostrarTela(tela) { 
        document.getElementById('tela-dashboard').style.display = tela === 'dashboard' ? 'block' : 'none'; 
        document.getElementById('tela-novo').style.display = tela === 'novo' ? 'block' : 'none'; 
        document.querySelectorAll('.sidebar .btn').forEach(btn => btn.classList.remove('active'));
        if (tela === 'dashboard') document.querySelector('.sidebar .btn:first-of-type').classList.add('active');
        else document.querySelector('.sidebar .btn:nth-of-type(2)').classList.add('active');
    }

    // Atalhos
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); document.getElementById('busca-rapida')?.focus(); }
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') { e.preventDefault(); if (eventoAtual) abrirModalAdd(); }
        if ((e.ctrlKey || e.metaKey) && e.key === 'i') { e.preventDefault(); if (eventoAtual) abrirModalImport(); }
        if ((e.ctrlKey || e.metaKey) && e.key === 'r' && eventoAtual) { e.preventDefault(); carregarEventoEspecifico(eventoAtual); }
    });
</script>
</body>
</html>
