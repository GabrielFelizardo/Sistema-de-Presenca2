<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Check-in Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #2563eb; --presente: #10b981; --ausente: #f59e0b; --bg: #f1f5f9; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* UTILITARIOS */
        .hide { display: none !important; }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:none; justify-content:center; align-items:center; }
        
        /* LOGIN */
        #tela-auth { position: fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(135deg, #1e293b, #0f172a); z-index:2000; display:flex; align-items:center; justify-content:center; }
        .auth-box { background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 400px; text-align: center; }

        /* LAYOUT GESTﾃグ */
        .sidebar { height: 100vh; background: white; width: 250px; position: fixed; border-right: 1px solid #e2e8f0; padding: 20px; z-index:100; }
        .content { margin-left: 250px; padding: 30px; transition: margin 0.3s; }
        .card-evento { background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; border-left: 5px solid var(--primary); cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-evento:hover { transform: translateX(5px); }

        /* MODO CHECK-IN (TABLET) */
        #modo-checkin { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); z-index: 5000; overflow-y: auto; display: none; }
        .checkin-header { position: sticky; top:0; background: white; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 10; }
        .stats-bar { display: flex; gap: 10px; margin-top: 10px; }
        .stat-pill { flex: 1; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; font-size: 1.1rem; }
        .stat-presente { background: #d1fae5; color: #065f46; }
        .stat-restante { background: #fee2e2; color: #991b1b; }
        
        .grid-convidados { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; padding: 15px; padding-bottom: 80px; }
        .card-guest { background: white; border-radius: 12px; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 2px solid transparent; transition: all 0.2s; }
        .card-guest.presente { border-color: var(--presente); background-color: #f0fdf4; }
        .btn-check { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .btn-check.unchecked { background: #e2e8f0; color: #94a3b8; }
        .btn-check.checked { background: var(--presente); color: white; transform: scale(1.1); }

        .btn-sair-checkin { position: fixed; bottom: 20px; right: 20px; background: #ef4444; color: white; border-radius: 50px; padding: 10px 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); border: none; z-index: 20; font-weight: bold; }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); position: absolute; }
            .content { margin-left: 0; }
        }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 fw-bold text-muted">Carregando...</p>
    </div>
</div>

<div id="tela-auth">
    <div class="auth-box">
        <i class="fas fa-check-circle fa-4x text-primary mb-3"></i>
        <h3 class="fw-bold">Check-in Pro</h3>
        <p class="text-muted">Gestﾃ｣o de acesso simples.</p>
        <form onsubmit="autenticar(event)">
            <input type="email" id="email" class="form-control mb-3" placeholder="Seu E-mail" required>
            <input type="password" id="senha" class="form-control mb-3" placeholder="Sua Senha" required>
            <button type="submit" class="btn btn-primary w-100 btn-lg">Entrar / Criar</button>
        </form>
    </div>
</div>

<div id="app-gestao" class="hide">
    <div class="sidebar d-flex flex-column">
        <h5 class="fw-bold text-primary mb-4">Meus Eventos</h5>
        <div id="lista-eventos-sidebar" class="flex-grow-1 overflow-auto">
            </div>
        <button class="btn btn-outline-primary mt-3 w-100" onclick="modalNovoEvento()">+ Novo Evento</button>
        <button class="btn btn-light mt-2 w-100 text-danger" onclick="logout()">Sair</button>
    </div>

    <div class="content">
        <div id="view-vazio" class="text-center mt-5 opacity-50">
            <i class="fas fa-calendar-alt fa-5x mb-3"></i>
            <h3>Selecione ou crie um evento</h3>
        </div>

        <div id="view-evento" class="hide">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                <h2 class="fw-bold m-0" id="titulo-evento">Nome do Evento</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-success btn-lg shadow-sm" onclick="iniciarModoCheckin()">
                        <i class="fas fa-play-circle me-2"></i>INICIAR CHECK-IN
                    </button>
                    <button class="btn btn-outline-secondary" onclick="modalImportar()"><i class="fas fa-file-excel"></i></button>
                    <button class="btn btn-outline-danger" onclick="excluirEventoAtual()"><i class="fas fa-trash"></i></button>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <h5>Lista de Convidados</h5>
                        <button class="btn btn-sm btn-primary" onclick="modalAdicionarPessoa()">+ Adicionar Manual</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover" id="tabela-gestao">
                            <thead class="table-light"></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modo-checkin">
    <div class="checkin-header">
        <div class="d-flex gap-2">
            <input type="text" id="busca-checkin" class="form-control form-control-lg" placeholder="剥 Buscar nome..." onkeyup="filtrarCheckin()">
            <button class="btn btn-light border" onclick="limparBusca()"><i class="fas fa-times"></i></button>
        </div>
        <div class="stats-bar">
            <div class="stat-pill stat-presente">
                <i class="fas fa-user-check me-2"></i><span id="contador-presentes">0</span>
            </div>
            <div class="stat-pill stat-restante">
                <i class="fas fa-user-clock me-2"></i><span id="contador-restantes">0</span>
            </div>
        </div>
    </div>

    <div class="grid-convidados" id="grid-cards">
        </div>

    <button class="btn-sair-checkin" onclick="sairModoCheckin()">
        <i class="fas fa-arrow-left me-2"></i>Voltar
    </button>
</div>

<div class="modal fade" id="modalNovo" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Novo Evento</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input id="novo-nome" class="form-control mb-3" placeholder="Nome do Evento"><label>Colunas (separadas por vﾃｭrgula):</label><input id="novo-cols" class="form-control" value="Nome,Empresa,Cargo,Status"></div><div class="modal-footer"><button class="btn btn-primary" onclick="criarEvento()">Criar</button></div></div></div></div>
<div class="modal fade" id="modalAdd" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Adicionar Pessoa</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="form-dinamico"></div><div class="modal-footer"><button class="btn btn-primary" onclick="salvarPessoa()">Salvar</button></div></div></div></div>
<div class="modal fade" id="modalImport" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Importar (Copiar do Excel)</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><textarea id="texto-import" class="form-control" rows="10" placeholder="Cole aqui..."></textarea></div><div class="modal-footer"><button class="btn btn-success" onclick="processarImport()">Importar</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyS3khi5I0vPcPPKCoVmbnuwK82_-wE4y8uid-qWd-Tz7Z2rD5wRCZsWHHZuohRh0s2/exec"; 

    // Estado Local
    let USER = { id: localStorage.getItem('checkin_id'), email: localStorage.getItem('checkin_email') };
    let eventoAtual = null;
    let dadosEvento = [];
    let colunasEvento = [];

    // --- INICIALIZAﾃﾃグ ---
    document.addEventListener('DOMContentLoaded', () => {
        if(USER.id) {
            document.getElementById('tela-auth').classList.add('hide');
            document.getElementById('app-gestao').classList.remove('hide');
            carregarListaEventos();
        }
    });

    async function api(acao, dados={}) {
        document.getElementById('loading').style.display = 'flex';
        dados.idPlanilha = USER.id;
        try {
            const r = await fetch(API_URL, {method:'POST', body:JSON.stringify({acao, ...dados})});
            const j = await r.json();
            document.getElementById('loading').style.display = 'none';
            if(j.erro) { alert(j.erro); return null; }
            return j;
        } catch(e) {
            document.getElementById('loading').style.display = 'none';
            alert("Erro de conexﾃ｣o."); return null;
        }
    }

    // --- AUTH ---
    async function autenticar(e) {
        e.preventDefault();
        const em = document.getElementById('email').value;
        const se = document.getElementById('senha').value;
        
        // Tenta login, se falhar por "nﾃ｣o encontrado", tenta registrar (simplicidade UX)
        let r = await api('autenticar', {tipo:'login', email:em, senha:se});
        if(!r) {
            if(confirm("Conta nﾃ｣o encontrada. Deseja criar uma nova com este email/senha?")) {
                r = await api('autenticar', {tipo:'register', email:em, senha:se});
            }
        }

        if(r && r.sucesso) {
            USER = { id: r.idPlanilha, email: r.email };
            localStorage.setItem('checkin_id', r.idPlanilha);
            localStorage.setItem('checkin_email', r.email);
            location.reload();
        }
    }

    function logout() { localStorage.clear(); location.reload(); }

    // --- GESTﾃグ ---
    async function carregarListaEventos() {
        const r = await api('listarEventos');
        const div = document.getElementById('lista-eventos-sidebar');
        div.innerHTML = '';
        if(r) r.forEach(ev => {
            div.innerHTML += `<div class="card-evento" onclick="abrirEvento('${ev.nome}')"><strong>${ev.nome}</strong></div>`;
        });
    }

    async function abrirEvento(nome) {
        eventoAtual = nome;
        document.getElementById('view-vazio').classList.add('hide');
        document.getElementById('view-evento').classList.remove('hide');
        document.getElementById('titulo-evento').innerText = nome;
        
        const r = await api('obterDados', {nomeEvento: nome});
        if(r) {
            colunasEvento = r.headers;
            dadosEvento = r.rows;
            renderizarTabelaGestao();
        }
    }

    function renderizarTabelaGestao() {
        const thead = document.querySelector('#tabela-gestao thead');
        const tbody = document.querySelector('#tabela-gestao tbody');
        thead.innerHTML = `<tr>${colunasEvento.map(c=>`<th>${c}</th>`).join('')}<th>Aﾃｧﾃ｣o</th></tr>`;
        tbody.innerHTML = dadosEvento.map((row, i) => `
            <tr>
                ${row.map(c=>`<td>${c}</td>`).join('')}
                <td><button class="btn btn-sm btn-light text-danger" onclick="excluirPessoa(${i})"><i class="fas fa-trash"></i></button></td>
            </tr>`).join('');
    }

    // --- CRIAﾃﾃグ E EDIﾃﾃグ ---
    function modalNovoEvento() { 
        document.getElementById('novo-nome').value = '';
        new bootstrap.Modal(document.getElementById('modalNovo')).show(); 
    }
    
    async function criarEvento() {
        const nome = document.getElementById('novo-nome').value;
        const cols = document.getElementById('novo-cols').value.split(',').map(s=>s.trim());
        const r = await api('criarEvento', {nome:nome, colunas:cols});
        if(r) { bootstrap.Modal.getInstance(document.getElementById('modalNovo')).hide(); carregarListaEventos(); }
    }

    function modalAdicionarPessoa() {
        const form = document.getElementById('form-dinamico');
        form.innerHTML = colunasEvento.map(c => 
            c === 'Status' ? '' : `<div class="mb-2"><label>${c}</label><input class="form-control inp-add"></div>`
        ).join('');
        new bootstrap.Modal(document.getElementById('modalAdd')).show();
    }

    async function salvarPessoa() {
        const inputs = document.querySelectorAll('.inp-add');
        const vals = [];
        let i = 0;
        colunasEvento.forEach(c => {
            if(c==='Status') vals.push('Pendente');
            else { vals.push(inputs[i].value); i++; }
        });
        
        const r = await api('adicionarPessoa', {nomeEvento:eventoAtual, arrayDados:vals});
        if(r) { 
            bootstrap.Modal.getInstance(document.getElementById('modalAdd')).hide(); 
            abrirEvento(eventoAtual); 
        }
    }

    function modalImportar() { document.getElementById('texto-import').value=''; new bootstrap.Modal(document.getElementById('modalImport')).show(); }
    async function processarImport() {
        const txt = document.getElementById('texto-import').value;
        const linhas = txt.trim().split('\n');
        const matriz = linhas.map(l => {
            const cols = l.split('\t');
            // Adiciona pendente se faltar
            if(cols.length < colunasEvento.length) cols.push('Pendente');
            return cols;
        });
        const r = await api('importarExcel', {nomeEvento:eventoAtual, matriz:matriz});
        if(r) { bootstrap.Modal.getInstance(document.getElementById('modalImport')).hide(); abrirEvento(eventoAtual); }
    }

    async function excluirPessoa(i) {
        if(confirm("Excluir?")) {
            await api('excluirPessoa', {nomeEvento:eventoAtual, linha:i});
            abrirEvento(eventoAtual);
        }
    }
    
    async function excluirEventoAtual() {
        if(confirm("EXCLUIR O EVENTO INTEIRO?")) {
            await api('excluirEvento', {nomeEvento:eventoAtual});
            location.reload();
        }
    }

    // =========================================================
    // 噫 MODO CHECK-IN (A Lﾃ敵ICA DO TABLET)
    // =========================================================

    function iniciarModoCheckin() {
        document.getElementById('modo-checkin').style.display = 'block';
        renderizarCardsCheckin();
        atualizarContadores();
    }

    function sairModoCheckin() {
        document.getElementById('modo-checkin').style.display = 'none';
        abrirEvento(eventoAtual); // Recarrega para refletir mudanﾃｧas na gestﾃ｣o
    }

    function renderizarCardsCheckin(filtro = "") {
        const grid = document.getElementById('grid-cards');
        const idxNome = colunasEvento.indexOf('Nome');
        const idxEmpresa = colunasEvento.findIndex(c => c.includes('Empresa') || c.includes('Cargo') || c.includes('Mesa')); // Tenta achar info extra
        const idxStatus = colunasEvento.indexOf('Status');

        let html = "";
        
        dadosEvento.forEach((row, i) => {
            const nome = row[idxNome] || "Sem Nome";
            const infoExtra = idxEmpresa > -1 ? row[idxEmpresa] : "";
            const status = row[idxStatus];
            
            if (filtro && !nome.toLowerCase().includes(filtro.toLowerCase())) return;

            const isPresente = status === 'Confirmado' || status === 'Presente';
            
            html += `
            <div class="card-guest ${isPresente ? 'presente' : ''}" id="card-${i}">
                <div>
                    <h5 class="fw-bold mb-1">${nome}</h5>
                    <small class="text-muted">${infoExtra}</small>
                </div>
                <button class="btn-check ${isPresente ? 'checked' : 'unchecked'}" onclick="togglePresenca(${i}, ${idxStatus})">
                    <i class="fas ${isPresente ? 'fa-check' : 'fa-user'}"></i>
                </button>
            </div>`;
        });
        
        grid.innerHTML = html;
    }

    async function togglePresenca(index, colStatusIndex) {
        // UI OTIMISTA (Muda visualmente antes de salvar para ser rﾃ｡pido)
        const row = dadosEvento[index];
        const statusAtual = row[colStatusIndex];
        const novoStatus = (statusAtual === 'Confirmado' || statusAtual === 'Presente') ? 'Pendente' : 'Presente';
        
        // Atualiza localmente
        dadosEvento[index][colStatusIndex] = novoStatus;
        
        // Atualiza DOM especﾃｭfico (sem re-renderizar tudo para nﾃ｣o perder scroll)
        const card = document.getElementById(`card-${index}`);
        const btn = card.querySelector('.btn-check');
        const icon = btn.querySelector('i');
        
        if (novoStatus === 'Presente') {
            card.classList.add('presente');
            btn.classList.remove('unchecked');
            btn.classList.add('checked');
            icon.className = 'fas fa-check';
        } else {
            card.classList.remove('presente');
            btn.classList.remove('checked');
            btn.classList.add('unchecked');
            icon.className = 'fas fa-user';
        }
        
        atualizarContadores();

        // Envia para o servidor em background (sem loading screen)
        // Se falhar, terﾃｭamos que reverter, mas para MVP assumimos sucesso ou alertamos erro.
        try {
            await fetch(API_URL, {
                method: 'POST', 
                body: JSON.stringify({
                    acao: 'atualizarStatus',
                    idPlanilha: USER.id,
                    nomeEvento: eventoAtual,
                    linha: index,
                    novoStatus: novoStatus
                })
            });
        } catch(e) {
            console.error("Falha ao salvar status", e);
            alert("Erro ao salvar no servidor! Verifique conexﾃ｣o.");
        }
    }

    function atualizarContadores() {
        const idxStatus = colunasEvento.indexOf('Status');
        let presentes = 0;
        dadosEvento.forEach(r => {
            if (r[idxStatus] === 'Confirmado' || r[idxStatus] === 'Presente') presentes++;
        });
        
        document.getElementById('contador-presentes').innerText = presentes;
        document.getElementById('contador-restantes').innerText = dadosEvento.length - presentes;
    }

    function filtrarCheckin() {
        const termo = document.getElementById('busca-checkin').value;
        renderizarCardsCheckin(termo);
    }
    
    function limparBusca() {
        document.getElementById('busca-checkin').value = '';
        renderizarCardsCheckin();
    }

</script>
</body>
</html>
